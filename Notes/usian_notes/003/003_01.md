# 第三阶段

## 3.01

### 1.1创建一个对象

```js
// 对象定义:无序的属性的集合

// 创建对象的方式1:   字面量
var obj = {"name":"gao","age":18,"say":function(){},"hobby":["唱歌"]};

// 方式2:   new Object(); 实例化 构造函数

var obj2 = new Object({"name":"gao"});
    obj2.age = 18;
    console.log(obj2);

//方式3:
//Object.create()方法创建一个新对象，使用现有的对象来提供新创建的对象的__proto__。
const person = {
    isHuman: false,
    printIntroduction: function () {
        console.log(`My name is ${this.name}. Am I human? ${this.isHuman}`);
        //My name is Matthew. Am I human? true
    }
};

const me = Object.create(person);

me.name = 'Matthew'; // "name" is a property set on "me", but not on "person"
me.isHuman = true; // inherited properties can be overwritten

me.printIntroduction();
console.log("me:", me);

```

### 1.2  对象的操作

```js
// 无序属性的集合
var obj = {};

// 增!!----对象的属性名含有空格或者特殊字符的用[]
obj.name = "gao";
obj[" x y"] = 8;
obj.age = 18;
obj["% cz"] = "99999";
console.log(obj);

// 删
delete obj.age;

delete obj["% cz"];

console.log(obj);

// 改
obj.name = "wang";
console.log(obj);

// 查
console.log( obj.name );
console.log( obj[" x y"] );

//对象的遍历
for(let key in obj){
    console.log("key--",key);
    console.log("值value--", obj[key]);
}

//对象的key名唯一
console.log({a:1,a:2})  //结果为a:2


//Object.defineProperty() 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性，并返回此对象。
```

### 1.3  创建多个对象方法1--工厂模式

工厂模式缺点:每个对象的方法重复,太耗费性能,没有从属关系,无法用 instanceof 判断,

```js
function students(name,age){
    var obj = {
    "name": name,
    "age": age,
    "say": function (msg) {
        console.log("会说", msg);
    }
    };
    return obj;
}

var one = students("秦",19);//实例化对象
var two = students("赵",16);//实例化对象

console.log(one);
console.log(two);

one.say("陕西");
two.say("山西");
```

### 1.3  创建多个对象方法1--构造函数

构造函数模式:可用instanceof判断从属关系

```js
 // 构造函数 
function Students(name,age){
    this.name = name;
    this.age = age;
    this.say = function(msg){
        console.log("会说",msg)
    }
 }

var one = new Students("gao",18);//实例化对象
var two = new Students("wang",19);//实例化对象

console.log(one);
console.log(two);

one.say("山西");
two.say("陕西");

// 构造函数 函数名 首字母大写
// 构造函数 内部   this 关键词 为属性赋值
// 构造函数 需要 new （实例化为对象）
```

### 1.3  创建多个对象方法1--原型模式

```js
// 原型模式
function Students(name,age){
    // 属性 写在 构造函数内
    this.name = name;
    this.age = age;
}

 var x = {
    "say":function(msg){
        console.log("会说",msg)
    },
    "yy":999
}

// prototype 原型对象 -- 方法
Students.prototype=x;

var one = new Students("gao",18);
var two = new Students("wang",28);

console.log(one);
console.log(two);
// 证明 one two 对象 使用 一个 x 对象 
// x.yy=888;
one.__proto__.yy = 8888;
console.log( one.yy ); // 888
console.log( two.yy ); // 888
```

### 1.4原型及   原型链

```js
// (原型)：每一个函数 中 都有一个 prototype 对象 ，这个对象叫原型对象；(原型)
function a(){

}
//测试看看有没有
console.log( a.prototype );


//原型链： 每一个对象中 都有 __proto__  指向构造函数的 prototype （原型/原型对象） ，一直到null 为止，形成的作用域链叫 原型链。

var obj = new Object();//Object() 构造函数 有 prototype（原型）；

console.log( obj.__proto__ );

console.log( Object.prototype );

console.log( obj.__proto__ == Object.prototype );//对象中   __proto__  指向构造函数的 prototype 

console.log( obj.__proto__.__proto__ ); // null

// 每个对象中 constructor 指向 该对象的构造函数
console.log( obj.constructor);
console.log( obj.constructor == Object); // Object 构造函数
```

```js
//原型--原型链
function Person(name,age){
    this.name=name;
    this.age=age;
}

Person.prototype.minHeight="20cm";
Person.prototype.dream=function(msg){
    console.log(`梦想是：`, msg)
}

    
var person = new Person("gao",20);

console.log(person);

console.log(person.__proto__  ==  Person.prototype);
// 对象的 __proto__  指向 构造函数的 原型对象 

console.log( Person.prototype.constructor == Person );

console.log( Person.prototype.__proto__.__proto__ );

console.log(  Object.prototype);
```

### 1.5  instanceof  in  ...

```js
//instanceof 从属关系
var arr = new Array();
// console.log( arr instanceof Array );

var obj = new Object();

// console.log( obj instanceof Object );

// var str="";
var str = new String();
// console.log( str instanceof String );


function St(name,age){
    this.name = name;
    this.age = age;
}

St.prototype.minHeight="20cm";

var one = new St("gao",30);//

// console.log( one instanceof Object);
// console.log( one instanceof St );
console.log(one, one.name, one.age);
console.log( one.minHeight );

// 判断 one 对象上 有没有  name 属性 age 属性 minHeight属性
// in 自身 + 原型链
console.log( "name" in one );
console.log( "age" in one );
console.log( "minHeight" in one );
console.log("------------------------------");

// hasOwnProperty 是否是自身 的属性
console.log( one.hasOwnProperty("name") );
console.log( one.hasOwnProperty("age") );
console.log( one.hasOwnProperty("minHeight") );
```

### 1.6  函数提升--

```js
// js   函数 是一等公民。
// 通过 调用 、事件驱动 可重复执行的代码块。
// 函数提升  用function 关键字声明的函数 有函数提升。
// 变量提升： 用var 声明的变量 会将 变量的声明 提升到它所在作用域的顶部；
var i;

for( i = 0; i<arr.length; i++){

}

console.log(i);// arr.length

fn1();
// 字面量
function fn1(){
    console.log("sssssss");
}
var fn1;
       


// fn2();// 报错 
// 函数表达式
var fn2= function(){

}

// new Function() 
/*
    var fn3= new Function("a","b","c","return a+b+c");
    console.log( fn3(1,2,3) );
*/
```

### 1.7  伪数组

#### 1.函数的属性和方法:

函数是由事件驱动的可以被调用的可重复使用的代码块,js中的函数是对象,因此函数也有属性和方法

一具名函数(字面量函数):
```js

name ();//函数调用可以放在函数声明的前后任何位置

function name(){

//代码块

};

name ();
```
二匿名函数(函数表达式)
```js
var fn = function(){

}

fn();//只能在函数后面被调用
```
自调用函数
```js
(function(){

}());

//new Function()实例化函数----不常用
var fn = new Function("参数1","参数2","参数3"....,"return a+b+c"){

}
```
//区别
1.函数提升---用function 关键字声明的函数有函数提升

```
```

#### 2.js预解析

```js
解析所有的全局函数及全局变量,都当做window的属性和方法
//函数内的var声明的变量会变量提升

var fn = function(){  ==var a;
consloe.log(a)			a = undefined;
var a = 10;				consloe.log(a)
}						a = 10;
```

属性:

length: 表示函数希望接收参数的个数 返回声明函数时传递的参数个数与实际调用时传递的参数个数没有关系

arguments:不定参数,调用时的参数集合是一个伪数组,是一个数组对象包含传入函数中的所有参数,主要用于保存函数参数


#### 3.伪数组转数组

```js
1.Array from(arguments)  //es6新语法
2.[...arguments]         //es6新语法
3.Array.prototype.slice.call
```



#### 4.函数递归

在函数内部调用的函数本身的函数,程序调用自身的变成技巧称之为**递归**,

 **优点: **可以用过少量的程序就可以描述出解题过程所需的重复计算,大大减少了程序的代码量,用有限的语句来定义对象的无限集合,

一般需要有边界条件,递归前进段和递归返回段,不满足时前进满足是返回  (例如阶乘)

#### 5.apply() call() bind():改变this指向

> apply() call()接收参数的方式不相同:
>
> ​		第一个参数都需要用到函数对象在函数体内第一个参数就是this的值,剩余的参数是需要传递给函数的值,call传的值可以是任意的apply()必须为数组;
>
> ​		经常用于扩展函数来一运行的作用域;
>
> ​		用来更改函数内部的this指针

> apply():应用于某一个对象的一个方法用另一个对象替换当前的对象的方法 
>
> ​	语法：B.apply(A,arguments)A对象用B对象的方法
>
> call():调用一个对象的方法,用另一个对象替换当前的对象的方法
>
> ​	语法：B.call(A,argsl1,argsl2) A对象调用B对象的方法

> apply() call() bind()比较:
>     apply() call()立即执行
>     bind()需要手动调用bind()()

>  call()直接传参call(1,2)
>     apply()用数组传参apply([1,2])
>     bind()()可以再任何一个括号内传参bind(1,2)()或者bind()(1,2)

#### 6.回调函数

函数A有一个参数这个参数是函数B 当函数A执行后执行函数B那么这个过程叫做  **回调**  (数组去重)

```js
function a(fn){
            fn(1,2)
   }
 a(function(a,b){
         console.log(a+b);
   });
```



#### 7.this指向

```js
谁调用指向谁()
//全局函数指向window
//对象中的函数--当前对象
//定时器/延时器中的this指向window
//事件--调用事件的当前对象
//对象中的方法里面的函数中(闭包)的this---window
//在函数内部再次声明一个函数时,内部函数中的this指向window

  // this ---对象
  // 普通 函数内部 this 指向 调用时所在对象
  //  调用 函数 .前面是什么 就是什么 ， .前面 没有 window
//-----------------------------
  // 全局函数 --window
  function a() {
      console.log(this);
  }
  a(); //-->window
//-----------------------------
  // 对象中的函数 -- 当前对象
  var obj = {
      say: function () {
          console.log(this);
      }
  }
  obj.say(); //-->obj
  var x = obj.say;
  x() //-->window
//-----------------------------
  //  延时器，定时器 -- -->window
  setTimeout(function () {
      console.log(this) // -->window
  }, 1000)
//-----------------------------
  // 闭包 -- window
  function fn() {
      return function () {
          console.log(this); //-->window
      }
  }
  fn()() // 
//-----------------------------
  // 事件  调用事件的 dom 对象
  var box = document.getElementById("box");
  box.onclick = function () {
      console.log(this); //-->box
  }
  function Fn1(a, b) {
      console.log("fn1-------", this, a, b);
  }
  var obj = {
      "name": "gao"
  };

//改变this指向
  Fn1.call(obj, 1, 2);

 //Fn1.apply(obj, 1, 2); //不是数组的话会出错
//Uncaught TypeError: CreateListFromArrayLike called on non-object
  Fn1.apply(obj, [1, 2]);

  Fn1.bind(obj)(1, 2);
```

#### 8.构造函数

- 与一般函数区别:
	- 函数名首字母大写
	- 调用方法:构造函数调用时需要通过new关键字进行调用
	- 通过关键字this向实例中添加属性及方法
	- 在new关键字调用时 后台自动返回一个对象 不需要我们书写
	- 通过构造函数创建对象时避免代码重复:传递参数不同创建的对象有所不同;

```js
var fun = function () {
    this.name = 'peter';
    return {
        name: 'jack'
    };
}
var p = new fun();
console.log(p, p.name); // jack 
```



```js
var fun = function () {
    this.name = 'peter';
    return 'jack';
}
var p = new fun();
console.log(p, p.name); //peter

```

构造函数默认会返回this对象,如果人为 `return` 一个基本数据类型,还是会返回this对象,特别的， 如果这个函数是构造函数， 则默认返回this对象， 如果构造函数内使用了return语句， 并且return后跟的是一个对象，则这个构造函数返回的是这个对象

通过 `instanceof` 操作符 测试一个对象是不是由指定的构造器函数所创建的返回值是布尔 eg.consloe.log(name instanceof object)

#### 9. `prototype` 属性
- 保存所有实例的方法也就是原型,允许向对象添加属性和方法适用于所有的 `js` 对象
```js

function person(){

}
person.prototype={

}

```

#### 10.原型链

原型链是一种关系,是实例对象和原型对象之间的关系,这种关系是通过原型(`proto`)来联系的。`JavaScript` 对象有一个指向一个原型对象的链。当试图访问一个对象的属性时，它不仅仅在该对象上搜寻，还会搜寻该对象的原型，以及该对象的原型的原型，依次层层向上搜索，直到找到一个名字匹配的属性或到达原型链的末尾。

实例对象的原型`__proto__`和构造函数的原型prototype指向是相同的，实例对象中的`__proto__`原型指向的是构造函数中的原型prototype。 console.log(per.__proto__==Person.prototype);

#### 11.操作符

- `instanceof`  判断数据类型 判断属于哪一个构造函数
- `in` 判断是  自身+原型链
- `hasOwnProperty`  验证是否是自身的属性 不包含原型链属性


#### 12.工厂函数

```js
function studentS(name,age){
var obj{
name=name
age=age
}
var wk=students("赵",18);
consloe.log(wk);
```

#### 13.封装

- 封装是一种将抽象性函数接口的实现细节部分包装隐藏起来的方法要访问代码和数据必须通过接口控制
- __功能__:我们可以修改自己的实现代码不用修改那些调用我们代码的程序片断加强代码安全性方便维护
- **优点**:
	- 连刚好的封装可以减少耦合
	- 类内部的结构可以自由修改
	- 可以对成员变量进行精准控制

# JS进阶02:---面向对象--`jQuery`选择器

补充

- `dom` 树加载完全之后就立即加载
- `$.noConflict();` 释放`$ `后面的`$`不可以使用避免多个框架`$`出现冲突
`var wd=jQuery.noConflict();`用`wd(为任意参数)`替代`$`


#### 1.面向对象的编程写法

**面向过程**就是分析出解决问题所需要的步骤，然后用函数把这些步骤一步一步实现，使用的时候一个一个依次调用就可以了；

**面向对象**是把构成问题事务分解成各个对象，建立对象的目的不是为了完成一个步骤，而是为了描叙某个事物在整个解决问题的步骤中的行为。

————————————————

1  面向过程编程中，开发者注重于程序功能实现的过程，编程过程中扮演类似执行者的角色
2  面向对象编程中，开发者注重于对象的创建和调用，编程过程中扮演类似指挥者的角色
3  面向过程编程中，开发者可以精准把控程序执行的每一步和每一个细节（比如：手洗衣服过程中，衣服的哪个部位需要多搓一会，扇扇子的时候多扇头还是扇脚）
4  面向对象编程中，开发者无需知道对象的每一个细节，对象如何工作交给对象的设计者完成（当然开发者常常扮演设计者的角色，同时已经有很多东西已经被设计好了）
5  面向过程设计方式在中小型项目中更有优势。开发者只需要想好步骤，再依据步骤写下来即可。
6  面向对象设计方式在大中型项目中更有优势。开发者设计好对象后，只需调用对象完成任务使得代码更简洁易懂易于维护。
7  面向对象设计方式在宏观上是面向对象的，在微观上依旧是面向过程的。 在每个对象的内部有着它们的行为属性（扫地、洗衣服、吹风），设计者在设计如何让它们工作的过程中依旧是按照面向过程的思想让程序按照步骤执行。由此可见：面向过程是程序设计的基本方式
————————————————

#### 2.面向对象三大好处:封装 继承 多态 特点还有一个   唯一 

继承:
- 1、原型链继承:
    **语法**: `子.prototype=new 父()`
	**优点**: 可以继承父类所有属性(自身+原型链)
    **缺点**: 不可以动态给父类 构造函数 传参数

```js
 function Father(name,sex){
    this.name=name;
    this.sex=sex;
}
Father.prototype.say=function(){
    console.log("会说陕西话");
}

// 子
function Son(){

}
Son.prototype= new Father( "王","男" );

var one = new Son();
console.log(one,one.name,one.sex);
one.say();

var two = new Son();
console.log(two);
```
- 2、类式继承(借用构造函数实现继承/通过改变`this`实现继承)  		
**语法**:子类构造函数内 `父类.call(this,参数1,参数2)`
**优点**:可以给父类构造函数传参数
**缺点**:不能继承父类 的原型 对象
```js
function Father(name,sex){
    this.name=name;
    this.sex=sex;
}
Father.prototype.say=function(){
    console.log("会说陕西话");
}

function Son(a,b){
    // console.log(a,b); 
    Father.call(this,a,b);
}

var one =new Son("高","男");
var two =new Son("王","女");
console.log(one);
console.log(two);
// one.say();
```
- 3、组合继承    
    - **优点**:可以继承父类所有属性(自身+原型链),:可以给父类构造函数传参数
```js
// 父类

function Father(name, sex) {
    this.name = name;
    this.sex = sex;
}
Father.prototype.say = function () {
    console.log("会说陕西话");
}

// 组合继承
function Son(a,b){
    Father.call(this,a,b); //类式继承
}

Son.prototype= Father.prototype //原型链继承


var one =new Son("gao","男");
console.log(one);
one.say();
```

##### 2.3  `new` 都干了什么?

```js
function Gou(name){
    this.name=name;
}

Gou.prototype.say=function(){
    console.log("aaaa");
}

var x= new Gou("gao");
console.log(x);

// new 干了什么？

var obj= {}; // 创建 空 对象

 obj.__proto__ = Gou.prototype; // 设置原型链（ 指向构造函数的原型 ）

  Gou.call(obj,"gao"); // 改变 构造函数的 this 指向 -- obj

console.log(obj); // 返回 对象；
```

##### 2.4  回调函数

```js
// 将一个函数 当作参数  传入另一个函数 ，这个函数叫回调函数。
// function(){} 匿名函数

function a(fn){
    fn(1,2);
}

a( function(a,b){
    console.log( a+b );
} )
```

##### 2.5  闭包函数

- **定义**：可以访问 一个函数 内部变量 的函数 叫闭包函数 -- 闭包
- **写法/表现形式**： 函数嵌套函数，内部函数可以访问外部函数的变量
- **原理**:内部函数可以访问外部函数的变量,变量在函数内找,如果没有,往上找,如果没有,再往上找
- **应用场景1:**循环加点击事件获得下标,事件委托ul下li加点击事件,

```js
//使用闭包获得点击li下标
var lis=document.getElementById("ul").children;
for(var i=0;i<lis.length;i++){
    function  a(i){
        lis[i].onclick=function(){
        console.log(i) 
     }
   }
a(i);
}

//上面闭包案例简化为自执行
var lis = document.getElementById("ul").children;
for(var i = 0; i<lis.length;i++){
    (function(i){
        lis[i].onclick=function(){
            console.log(i) 
        }
    })(i)
}
```

**应用场景2:**计时器传参

```js
funaction x(a,b){
    var a = 1,b = 2;

    //延迟多少时间执行,过3秒打印a+b的值

    setTimeout(function(){
        console.log(a+b)
    },3000)
}
x(2,3);
```

**应用场景:**隔离变量,详见`jquery`源码

- 优点：
    - 1、 可以访问 一个函数内部变量
    - 2、 闭包变量 长期驻扎内存
- 缺点：
    - 因为 闭包变量 长期驻扎内存 不会触发垃圾回收机制，可能 内存占用过大 导致 内存泄漏    
- 垃圾回收机制：
    - 1、标记清除
    - 2、引用计数

```js
 function a(){
    var b=123; 

    // 闭包函数
    return function(){
        console.log(b); // b 闭包变量
     }
 }
a()();
```

##### 2.6  `js` 执行机制

**从上到下---先同步后异步---先宏任务后微任务.**

搜索`js`的执行机制前3篇都可以

宏任务: `Script` , `setTimeout` , `setInterval`,

微任务 `Promise` , `process` , `nextTick` 

下面 `promise` 相关的面试题

```js
console.log(1);
setTimeout(function(){
    console.log(3);//异步---微任务
    },0)
    
    var x = new Promise(function(ok,no){
        console.log(4);//一旦创建立即执行
        ok("aaaaaaa")
    })
    x.then(function(res){
        console.log(res,5);//异步--宏任务
    })
    console.log(2);
    //执行顺序为1--4---2---5---3
    //
```



#### 3.`jQuery`
- 了解**可以看看`jquery`源码分析--看整体架构**
- 了解**`jquery`  怎么实现不用`new`**
- 获取元素是数组 

```js
引入  :<script src="./jquery.js"></script>
定义:封装了js可以实现的功能
        dom 操作
        动画操作
        ajax         
//获取dom节点   
    console.log($("#box"));
//获取值 
    console.log( $("#box").text());
       
//串联写法        
$("#box").css("color","pink").css("background","skyblue")
        
 //转化      
 console.log( $("#one")[0] ); // jq dom 转 js dom    [下标]
 console.log( $("#one").get(0) )//jq dom 转 js dom   .get(下标)    
```

#### 4.选择器



4. 1基本选择器

```js
$(".a ,.b").css("color","pink");     //群组选择器
$("#ul").css("background","green");  //id选择器
$(".a").css("background","blue");    //class选择器
$("*").css("background","blue");     //通配选择器
```

4.2层级选择器

```js
$("#ul li").css("color","red");     //后代
$("#ul >li").css("color","blue");   //子选择器
$(".a ,.b").css("color","pink");    //群组选择器
$(".a +li").css("color","orange");  //下一个兄弟选择器
$(".a ~li").css("color","green");   //下面所有兄弟选择器
```

4.3基本筛选选择器

```js
$("#ul>li:first").css("color","red");     //第一个
$("#ul>li:last").css("color","orange");   //最后一个
$("#ul>li:eq(2)").css("color","yellow");  //第几个
$("#ul>li:gt(2)").css("color","green");   //下标大于
$("#ul>li:lt(2)").css("color","skyblue"); //下标小于

$("#ul>li:even").css("color","blue");     //偶数下标
$("#ul>li:odd").css("color","pink");      //奇数下标

$("#ul>li:not(.one)").css("color","deeppink");   //除..以外

$("input")
```

4.4内容

```js
//内容
//内容包含字符   :contains
$("div:contains(卡)").css("color","red");

//空节点 :empty
$("div:empty").css("color","green");

//包含..选择器  :has(selector)
$("div:has(p)").css("color","pink");

//有子节点  :parent
$("div:parent").css("color","yellow");
```

4.5可见性

```js
//可见性
//隐藏元素  :hidden
console.log($("div:hidden"));

//显示元素 :visible
console.log($("div:visible"));
```

4.6css属性选择器

```js
$("[class]").css("color","skyblue");  //包含class属性
$("[class=x]").css("color","red");   //包含class=x
$("[class^=x]").css("color","orange");  //以x开头的
$("[class*=x]").css("color","yellow");  //包含x的
$("[class!=x]").css("color","green");  //不包含x的
```

4.7子元素选择器

```js
:first-child
:first-of-type
:last-child
:last-of-type
:nth-child
:nth-last-child()
:nth-last-of-type()
:nth-of-type()
:only-child
:only-of-type

```

4.8 表单

```js
:input          获得所有表单元素
:text           获取 type =text 的节点
:password       获取 type =password 的节点
:radio          获取 type =radio 的节点
:checkbox       获取 type =checkbox 的节点
:submit         获取 type =submit 的节点
:image          获取 type =image  的节点
:reset          获取 type =reset 的节点
:button         获取 type =button 的节点
:file           获取 type =file 的节点
     表单对象属性
:enabled        可用的
:disabled       不可用
:checked        选中
:selected       下拉框选中
```

#### 5.代码文本值

```js
 //获取值
console.log(节点.text());   //1111
console.log(节点.html());  //<h1>1111</h1>  

//设置值
节点.text("<h2>222</h2>");  //<h2>222</h2>
节点.html("<h2>222</h2>") ;   //222

//获取表单值
console.log(节点.val());    //999
//设置表单值
节点.val("555555")     //555555
```

# JS03----jQuery的属性操作

#### 1.属性操作

```js
//attr获取自定义属性
//获取属性  attr("属性名")获取只获取相同命名的第一个
//设置属性值   设置同名的都会被设置
   节点.attr("id","iiiii");   //设置一个属性  ("属性","属性值")
   节点.attr({"id":"iiiii","class":"ooooo"})  //设置多个属性 {"属性":"属性值","属性":"属性值"}

//删除属性     //删除只能删除自己添加的不能删除原有的
   节点.removeAttr("zz");

//!!!prop只能获取内置属性,自定义属性无法获取
// prop()  使用场景表单单选 多选下拉框

   console.log($("checkbox").attr("checked"));  //undefined checked
   console.log( $("checkbox").prop("checked"));   //false true  
//$(v).prop("checked",true)
      
```

#### 2.class类操作

```js
节点.addClass("active");     //addClass添加class属性
节点.removeClass("active");  //removeClass  移除 class属性
节点.toggleClass("active");  //toggleClass  添加或移除 class属性  有移除,没有添加
```

#### 3.css

```js
//获取 class 内部 某个样式--color
console.log(节点.css("color"));    //color 获取到的是rgb样式

//获取 class 行内 某个样式--color
console.log(节点.css("color"));    //color 获取到的是rgb样式


// 设置一个属性  ("属性","值")
节点.css("fontSize","80px");

//设置多个属性  {"属性":"值","属性":"值"}
节点.css({"fontSize":"80px","background":"skyblue"});
```

#### 4.位置/偏移量

```js
//offset() 获取当前元素相对于视口的偏移量
//没有参数是获取left top 偏移量,有参数是设置

//获取偏移量
节点.offset();

//设置偏移量

节点.offset({"top":200,"left":500})
    
//position() 获取当前元素相对于父元素的偏移量

//获取偏移量
节点.position();

//设置偏移量

节点.position({"top":200,"left":500})
```

#### 5.创建文档

```js
 //创建文档
console.log(document.createElement("p"));
console.log($("<p></p>"))

//创建的文档转为js Dom节点
console.log($("<p></p>")[0])


//$("<标签></标签>")
```

#### 6.内部添加

```js
//内部添加
append(content|fn)  末尾添加
appendTo(content)
    父元素.append(子元素)
    子元素.appendTo(父元素)   //远离元素的位置

prepend(content|fn)开头添加
prependTo(content)
    父元素.prepend(子元素)
    子元素.prependTo(父元素)   //远离元素的位置
//外部添加
after()                      //外部之后添加  //远离元素的位置
insertAfter() 

before ()                   //外部之前添加   //远离元素的位置
insertBefore() 
```

#### 7.包裹

wrap(完整的标签)  每一个都包
unwrap()  去掉父级的包裹只去一层
warpAll  包裹在一个标签内
warpInner() 标签内的内容用标签包裹

```js
//为每一个匹配元素添加外部包裹
节点.wrap("<div></div>"); 

//去除外部包裹  只去一层
节点.unwrap();

//将所有匹配元素用一个元素包裹
节点.wrapAll("<div></div>");

//将匹配元素内部元素包裹起来
节点.warpInner("<span></span>");
```

#### 8.替换

```js
//将...替换为...
节点.replaceWith($("<div>2222</div>"));
    
//用..替换...
$("<div>2222</div>").replaceAll(节点)
```

#### 9.删除

```js
//清除子元素
节点.empty();

//删除自身
节点.remove();

//删除自身  保留 绑定的事件  和附加数据
节点.detach();
```

#### 10.克隆

```js
console.log(节点.clone());

节点.click(function(){
    console.log(1111111);
})

节点.append($("#box").clone(true))  //()内为true时 克隆的节点  保留 绑定的事件  和附加数据,默认为false不会保留事件
```

#### 11.`ready()`

```js
$(document).ready()    /*简化写法$(function(){console.log(44);})

/*ready()和window.onload区别

1、 window.onload 是原生js 的方法
        ready          是jquery 的方法

 2、  window.onload  需要等页面包含图片的所有元素加载完毕
        ready           dom 加载完毕

        ready 先执行     window.onload 后执行
 3、 window.onload  不能写多个，后面会覆盖前面
        ready           可以写多个*/
```

#### 12.事件

```js
//  绑定事件  on(一个或多个用空格分开的事件,"选择器字符串",当一个事件被触发时要传递event.data给事件处理函数(一般不需要写不用),该事件被触发时执行的函数。 false 值也可以做一个函数的简写，返回false)
        节点.on("click mouseover",function(){
            console.log("11111");
        })
//  移除事件
        节点.off("mouseover");
        
//  一次事件
        节点.one("click",function(){
            console.log("赞")
        })
//  事件委托     "li,p":选择器(实际发生的节点)
        事件加载的节点.on("click","li,p",function(){
            console.log(this);
        })
//复合事件
		  节点.hover( function(){
            // 鼠标悬停
            $(this).css("color","red");
        } , function(){
            // 鼠标离开
            $(this).css("color","black");
        } )
```

#### 13.tab切换

```javascript
//.click 为匹配的每一个元素 添加 点击事件*

$("#tab >li").click(function(){
  var index= $(this).index(); *// 获得在 父元素中的下标*

  *//.siblings() 获取同辈元素* 
  $(this).addClass("li_active").siblings().removeClass("li_active");

  *// eq( index ) 第几个下标*
  $("#tabbox >div").eq( index ).addClass("div_active").siblings().removeClass("div_active")

})
```

#### 14-1表单元素-- 获取表单元素值

```js
$("#add").click(function(event){
    event.preventDefault(); //阻止 默认事件
    // 文本框 
    var name= $("#name").val();
    // 单选
    var sex=  $(".sex:checked").val();
    // 多选
    var hobby=[];
    $(".userForm  :checkbox:checked").each(function(i,v){
        hobby.push( $(v).val() );
    })
    // 下拉
    var address=$("#address").val();

    console.log(name ,sex ,hobby, address);  
})
```



#### 14dom操作案例(表单元素  修改)



```js
// 1、模拟数据
var arr=[
    {
        "id":11,
        "name":"gao",
        "sex":"man",
        "hobby":["唱歌","说唱"],
        "address":"豫"
    },
    {
        "id":22,
        "name":"gao2",
        "sex":"woman",
        "hobby":["跳舞","说唱"],
        "address":"陕"
    },
    {
        "id":33,
        "name":"gao3",
        "sex":"man",
        "hobby":["唱歌","跳舞"],
        "address":"晋"
    }
]

// 2、渲染页面

function showFn(arr){
    if( arr.length >0 ){
        $("#h1").hide();
        $("#table").show();
        var str="";
        $.each(arr,function(i,v){
            str+=`
            <tr>
                <td>${i+1}</td>
                <td>${v.name}</td>
                <td>${v.sex}</td>
                <td>${v.hobby.join("-")}</td>
                <td>${v.address}</td>
                <td>
                    <button onclick="del(${v.id})">删除</button>
                    <button onclick="edit(${v.id})">修改</button>
                </td>
            </tr> 
            
            `
        })
    
        $("#tbody").html(str);
    }else{
        $("#h1").show();
        $("#table").hide();
    }
   
}

$(function(){
        showFn(arr);  
})


// 3、事件操作

// 删除
function del(id){
    // var index= arr.findIndex(v=>v.id == id)
    var index= arr.findIndex(function(v){
        return v.id == id
    })
    arr.splice(index,1);
    showFn(arr);
}


// 修改
var editIndex;
function edit(id){
     editIndex= arr.findIndex(v=>v.id == id);

     var obj = arr[editIndex];
    //  console.log(obj);

    // 文本框
    $("#name").val( obj.name );

    // 单选框
    $(".sex").each(function(i,v){

        if( $(v).val() == obj.sex ){
            $(v).prop("checked",true)
        }
    })

    // 复选框
    $(".userForm :checkbox").each(function(i,v){
        $(v).prop("checked",false);
    })

    $(".userForm :checkbox").each(function(i,v){

        if( obj.hobby.includes( $(v).val() ) ){
            $(v).prop( "checked",true );
        }
    })

    $("#address").val( obj.address )

}


```



# JS进阶04

#### 1-过滤

第几个-eq(index|-index    第一个first()    最后一个last()    

end() 回到最近的一个"破坏性"操作之前。即，将匹配的元素列表变为前一次的状态。

```js
$("li").eq(1).css("color","red");
$("li").eq(-1).css("color","red");
$("li").first().css("color","red").end().last().css("color","red")
```

​    hasClass(class)       is(expr|obj|ele|fn)       has(expr|ele)         not(expr|ele|fn)   map(callback)

```js
console.log(  $("li").hasClass("x") ) // true、false  是否有 x 类  class == x

var dom= $("li").filter(function(i,v){
    console.log(i,v);
   return  $(v).hasClass("x");
})
   console.log(dom);
            
console.log( $("li").children().is("span") );
 //children() 子元素
 
$("li").map(function(i,v){
   console.log(i,v)
 })
 
console.log($("li").has("span")) // 后代里 有 span 的li
console.log($("li").not(".x"));  //   不包含 class = x 的 li

console.log($("li").slice(0, 2));
```

节点 伪数组 转 数组 get()

```js
console.log( $("li").get() )

```

#### 2-查找

**parent([expr])**        //取得一个包含着所有匹配元素的唯一父元素的元素集合
**children([expr])**    //取得 匹配 元素集合 的所有子元素的元素集合。
find(e|o|e)            //搜索所有与指定表达式匹配的元素

**next([expr])**            //取得一个包含匹配的元素集合中每一个元素紧邻的后面同辈元素的元素集合。
nextAll([expr])      //查找当前元素之后所有的同辈元素。

**prev([expr])**            //取得一个包含匹配的元素集合中每一个元素紧邻的前一个同辈元素的元素集合 ,只有紧邻的同辈元素会被匹配到
**prevAll([expr])**       //查找当前元素之前所有的同辈元素 
  **siblings([expr])**   //取得一个包含匹配的元素集合中每一个元素的所有唯一同辈元素的元素集合  
                               // ( 获取 所有匹配元素的 所有同辈元素 的元素集合)

同时获得p标签和button标签使用add()

```javascript
console.log( $("p").add("button") );
        
```

#### 3-隐藏显示

hide-显示show-显示或隐藏toggle

```javascript
//显示 display
$("#show").click(function () {
$("#box").show();
})

//隐藏
$("#hide").click(function () {
$("#box").hide();
})

//显示或隐藏
$("#toggle").click(function () {
$("#box").toggle();
})
```

#### 4-向下滑出slideDown--向上滑入slideUp--滑入或滑出slideToggle

```javascript
//向下滑出 height  margin  padding  display   overflow:hidden
$("#slideDown").click(function () {
$("#box").slideDown(3000)
})

//向上滑入
$("#slideUp").click(function () {
$("#box").slideUp(5000)
})

//滑入或滑出
$("#slideToggle").click(function () {
$("#box").slideToggle(3000)
})
```

#### 5-自定义动画

```javascript
        $("#big").click(function () {
            $("#box").animate({
                width: "400px",
                height: "400px",
            }, 10000)
        })
        $("#stop").click(function(){
            $("#box").stop()//暂停
        })

        $("#finish").click(function(){
            $("#box").finish()//立即完成动画
        })
```

#### 6-less

https://less.bootcss.com/

```html
<link rel="stylesheet/less" type="text/css" href="styles.less" />
<script src="//cdnjs.cloudflare.com/ajax/libs/less.js/3.11.1/less.min.js" ></script>
```

less css 预处理器 ：给css 添加编程特性

变量、 判断 、函数->混合宏 

**嵌套**

```less
@import "./base.less";//外部引入

//混合宏 
    .b{
        border: 1px solid black;
    }
   

#box {
    width: @w;//宽设为变量
    height: 100px;
    .b();//调用混合宏
    
    background: @bgColor;//背景颜色设为变量
    div{
        h1{
            color: red;
            .b();//调用混合宏
        }
    }
}
```

#### 7-轮播图插件swiper

```html
<link rel="stylesheet" href="./swiper/swiper-bundle.css">
  <script src="./swiper/swiper-bundle.min.js"></script>
  <style>
    .swiper-container {
      width: 500px;
      height: 500px;
      border: 1px solid black;
    }
  </style>
</head>

<body>
  <div class="swiper-container">

    <!-- 轮播项目 -->
    <div class="swiper-wrapper">
      <div class="swiper-slide">Slide 1</div>
      <div class="swiper-slide">Slide 2</div>
      <div class="swiper-slide">Slide 3</div>
      <div class="swiper-slide">Slide 4</div>
      <div class="swiper-slide">Slide 5</div>
      <div class="swiper-slide">Slide 6</div>
      <div class="swiper-slide">Slide 7</div>
      <div class="swiper-slide">Slide 8</div>
      <div class="swiper-slide">Slide 9</div>
      <div class="swiper-slide">Slide 10</div>
    </div>

    <!--导航 -->
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
    <!-- 分页 -->
    <div class="swiper-pagination"></div>
  </div>
  <script>
// 文档地址：https://www.swiper.com.cn/api/autoplay/19.html
    var swiper = new Swiper('.swiper-container', {
      // 导航
      navigation: {
        //下一页
        nextEl: '.swiper-button-next',
        //上一页
        prevEl: '.swiper-button-prev',
      },
      // 分页
      pagination: {
        type: 'fraction',  //https://www.swiper.com.cn/api/pagination/299.html
        el: '.swiper-pagination',
        clickable: true, //分页是否可以被点击
      },
      // 自动播放
      autoplay: {
        // 延时时间
        delay: 2500,
        //用户操作swiper之后，是否禁止autoplay。默认为true：停止。
        disableOnInteraction: false,
      },
      // 循环播放
      loop:true

    });
  </script>
```

#### 8-TAB切换的另一种方法load

window.location.href="/";即可调出根目录

**/**    根目录

./   同级目录    或者当前目录

**../**   上一级



```html
    <ul>
        <li>要闻</li>
        <li>北京</li>
        <li>国内</li>
        <li>国际</li>
    </ul>

    <div id="tabBox">

    </div>

    <script>
        $("li").click(function(){
            var index= $(this).index();

            $("#tabBox").load( `./${ index+1 }.html` )
            
        })
    </script>
```

```
<div>
    <h1>要闻 内容</h1>
</div>
```



# JS进阶05

#### 1-url组成及浏览器安全机制

**浏览器安全机制**： 不允许 使用 非同源 的数据 (不允许使用 跨域请求得到的数据)


  **同源:** 协议、主机名、 端口 都一样

  **非同源：**协议、主机名、 端口 只要有一个不一样 


  **跨域：** 非同源的 请求 叫 跨域请求 【 www.baidu.com --->www.taobao.com 】

**浏览器漏洞：** link src 、 img src 、 a href 、 script src 可以访问非同源的资源



**联调**---与后端人员沟通数据给付物的过程

**数据接口 四要素** -- 提供人： 后端

1、请求地址

2、请求方式

3、上传参数 /入参

4、响应数据 /出参

```javascript
  "http://127.0.0.1:5500/day05/index?a=1&b=2#x"
Url {
 protocol: 'http:',                               协议*
 slashes: true,                                  是否有 ://    没有 null*  
 auth: null,                                     作者*
 host: '127.0.0.1:5500',                         主机* 
 port: '5500',                                   端口*
 hostname: '127.0.0.1',                           主机名*
 hash: '#x',                                      哈希*
 search: '?a=1&b=2',                              搜索*
 query: 'a=1&b=2',                                搜索语句/查询语句*
 pathname: '/day05/index',                           路径名* 
 path: '/day05/index?a=1&b=2',                       路径*
 href: 'http://127.0.0.1:5500/day05/index?a=1&b=2#x'
}

```

####   2  Ajax

Ajax即**Asynchronous-JavaScript-And-XML**（异步JavaScript和[XML](https://baike.baidu.com/item/XML/86251)）

**AJAX 不是新的编程语言**，而是一种使用现有标准的新方法。

**AJAX 最大的优点**是在不重新加载整个页面的情况下，可以与服务器交换数据并更新部分网页内容。

**AJAX 不需要任何浏览器插件**，但需要用户允许JavaScript在浏览器上执行。

**缺点:**不利于seo优化,网站没有前进后退,历史记录,不能收藏,不能分享

**兼容性:****为了应对所有的现代浏览器，包括 IE5 和 IE6，请检查浏览器是否支持 XMLHttpRequest 对象。如果支持，则创建 XMLHttpRequest 对象。如果不支持，则创建 ActiveXObject ：**

```js
var xmlhttp;
if (window.XMLHttpRequest){
//  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
    xmlhttp=new XMLHttpRequest();
}
else{
  // IE6, IE5 浏览器执行代码
    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
}
```

**同步请求**

```js
var xhr = new XMLHttpRequest();
xhr.open("GET", "./11.json", true);
xhr.send();
console.log(xhr.responseText);

```

**readyState:**存有 XMLHttpRequest 的状态。从 0 到 4 发生变化。

- 0: 请求未初始化
- 1: 服务器连接已建立
- 2: 请求已接收
- 3: 请求处理中
- 4: 请求已完成，且响应已就绪

```javascript
//-----AJAX的初步使用-----------
//request--在其他地方可简称为req,意思是请求;
//response-- 在其他地方可简称为res  意思是应答/响应
//目前**XML**不常用,目前常用的是**JSON**

//创建异步请求对象
var xhr = new XMLHttpRequest();

//打开连接--xhr.open(请求方式 、请求地址、是否异步)
xhr.open("GET", "http://127.0.0.1:5500/day05/%E8%87%AA%E5%B7%B1%E7%BB%83%E4%B9%A0/11.json", true);

//发送请求
xhr.send();

//监听状态改变
xhr.onreadystatechange = function () {
//ajax 状态   4成功       http 状态 200 成功
if (xhr.readyState == 4 && xhr.status == 200) {
console.log(xhr.responseText);
//转为对象
var obj = JSON.parse(xhr.responseText);

console.log(obj);

   }
}
      
```

```javascript
//换xml格式,对比JSON与xml两种格式的不同
var xhr = new XMLHttpRequest();

xhr.open("GET", "http://127.0.0.1:5500/day05/%E8%87%AA%E5%B7%B1%E7%BB%83%E4%B9%A0/11.xml", true);

xhr.send();

xhr.onreadystatechange = function () {
if (xhr.readyState == 4 && xhr.status == 200) {


console.log(xhr.responseXML);
var dom = xhr.responseXML;
console.log(dom.getElementsByTagName("name")[0]);
console.log(dom.getElementsByTagName("name")[0].tagName);
console.log(dom.getElementsByTagName("name")[0].innerHTML);

    }
}
```



#### 3补充:http基础知识

###### 一   http详解

 1.HTTP协议，即**超文本传输协议**(Hypertext transfer protocol)。是一种详细规定了**浏览器和万维网(WWW = World Wide Web)服务器**之间互相通信的规则，通过因特网传送万维网文档的数据传送协议。

   2.HTTP协议作为TCP/IP模型中应用层的协议也不例外。HTTP协议通常承载于TCP协议之上，有时也承载于TLS或SSL协议层之上，这个时候，就成了我们常说的HTTPS。

 3.HTTP是一个**应用层协议**，由请求和响应构成，是一个标准的客户端服务器模型。HTTP是一个**无状态**的协议。

  4.HTTP默认的端口号为**80**，HTTPS的端口号为**443**。

  5.浏览网页是HTTP的主要应用，但是这并不代表HTTP就只能应用于网页的浏览。HTTP是一种协议，只要通信的双方都遵守这个协议，HTTP就能有用武之地。比如咱们常用的QQ，迅雷这些软件，都会使用HTTP协议(还包括其他的协议)。

###### 二  http特点:

 1、**简单快速**：客户向服务器请求服务时，只需传送**请求方法**和**路径**。由于HTTP协议简单，使得HTTP服务器的程序规模小，因而通信速度很快。

  2、**灵活**：HTTP允许**传输任意类型的数据对象**。正在传输的类型由Content-Type加以标记。

  3、**HTTP 0.9和1.0使用非持续连接**：限制每次连接只处理一个请求，服务器处理完客户的请求，并收到客户的应答后，即断开连接。**HTTP 1.1使用持续连接**：不必为每个web对象创建一个新的连接，一个连接可以传送多个对象，采用这种方式可以节省传输时间。

  4、**无状态**：HTTP协议是**无状态协议**。**无状态是指协议对于事务处理没有记忆能力**。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。

 5、**支持B/S及C/S模式。*

###### 三 http流程:

一次HTTP操作称为一个事务，其工作过程可分为四步：

  1.首先客户机与服务器需要建立连接。只要单击某个超级链接，HTTP的工作开始。
  2.建立连接后，客户机发送一个请求给服务器，请求方式的格式为：统一资源标识符（URL）、协议版本号，后边是MIME信息包括请求修饰符、客户机信息和可能的内容。
  3.服务器接到请求后，给予相应的响应信息，其格式为一个状态行，包括信息的协议版本号、一个成功或错误的代码，后边是MIME信息包括服务器信息、实体信息和可能的内容。
 4.客户端接收服务器所返回的信息通过浏览器显示在用户的显示屏上，然后客户机与服务器断开连接。
 如果在以上过程中的某一步出现错误，那么产生错误的信息将返回到客户端，有显示屏输出。对于用户来说，这些过程是由HTTP自己完成的，用户只要用鼠标点击，等待信息显示就可以了。

###### 四.HTTP之请求消息Request

客户端发送一个HTTP请求到服务器的请求消息包括以下格式：

  **请求行**、**请求头部**、**空行**和**请求数据**四个部分组成。

**(1)Get请求例子**

**第一部分：请求行**，用来说明请求类型,要访问的资源以及所使用的HTTP版本.

GET说明请求类型为GET,[/562f25980001b1b106000338.jpg]为要访问的资源，该行的最后一部分说明使用的是HTTP1.1版本。

**第二部分：请求头部**，紧接着请求行（即第一行）之后的部分，用来说明服务器要使用的附加信息

从第二行起为请求头部，HOST将指出请求的目的地.User-Agent,服务器端和客户端脚本都能访问它,它是浏览器类型检测逻辑的重要基础.该信息由你的浏览器来定义,并且在每个请求中自动发送等等

第三部分：空行，请求头部后面的空行是必须的

即使第四部分的请求数据为空，也必须有空行。

**第四部分：请求数据也叫主体**，可以添加任意的其他数据。

这个例子的请求数据为空。

**POST请求例子**

第一部分：请求行，第一行明了是post请求，以及http1.1版本。
第二部分：请求头部，第二行至第六行。
第三部分：空行，第七行的空行。
第四部分：请求数据，第八行。

######  五.HTTP之响应消息Response

一般情况下，服务器接收并处理客户端发过来的请求后会返回一个HTTP的响应消息。

HTTP响应也由四个部分组成，分别是：**状态行**、**消息报头**、**空行**和**响应正文**。

第一部分：状态行，由HTTP协议版本号， 状态码， 状态消息 三部分组成。

第一行为状态行，（HTTP/1.1）表明HTTP版本为1.1版本，状态码为200，状态消息为（ok）

第二部分：消息报头，用来说明客户端要使用的一些附加信息

第二行和第三行和第四行为消息报头，
Date:生成响应的日期和时间；Content-Type:指定了MIME类型的HTML(text/html),编码类型是ISO-8859-1

第三部分：空行，消息报头后面的空行是必须的

第四部分：响应正文，服务器返回给客户端的文本信息。

空行后面的html部分为响应正文。

###### 六.HTTP之状态码          

状态代码有**三位数字**组成，第一个数字定义了响应的类别，共分五种类别:

1xx：**指示信息--表示请求已接收，继续处理**

2xx：**成功--表示请求已被成功接收、理解、接受**

3xx：**重定向--要完成请求必须进行更进一步的操作**

4xx：**客户端错误--请求有语法错误或请求无法实现**

5xx：**服务器端错误--服务器未能实现合法的请求**

常见状态码：

200   ok  ：                服务器已经成功接受请求

400  Bad Rrequest:      客户端请求有语法错误,不能被服务器所理解

402    Unauthorized:       客户未经授权  

403   Forbidden  :     服务器收到请求,但是拒绝提供服务

404  Not  Found:    请求资源不存在,eg输入了错误的url

500    Internal Server Error:  服务器发生不可预期的错误

**503    Server Unavailable:**   服务器当前不能处理客户端的请求,一段时间后可能恢复正常

###### 七.HTTP请求方法          

根据HTTP标准，HTTP请求可以使用多种请求方法。
**HTTP1.0**定义了三种请求方法： **GET, POST** 和 **HEAD**方法。
**HTTP1.1**新增了五种请求方法：**OPTIONS, PUT, DELETE, TRACE 和 CONNECT** 方法。

###### 八.HTTP工作原理           

​    HTTP协议定义Web客户端如何从Web服务器请求Web页面，以及服务器如何把Web页面传送给客户端。HTTP协议采用了**请求/响应模型**。客户端向服务器发送一个请求报文，请求报文包含请求的方法、URL、协议版本、请求头部和请求数据。服务器以一个状态行作为响应，响应的内容包括协议的版本、成功或者错误代码、服务器信息、响应头部和响应数据。

以下是 HTTP 请求/响应的步骤：

**1、客户端连接到Web服务器**

一个HTTP客户端，通常是浏览器，与Web服务器的HTTP端口（默认为80）建立一个TCP套接字连接。例如，[http://www.oakcms.cn。](http://www.oakcms.cn./)

**2、发送HTTP请求**

通过TCP套接字，客户端向Web服务器发送一个文本的请求报文，一个请求报文由请求行、请求头部、空行和请求数据4部分组成。

**3、服务器接受请求并返回HTTP响应**

Web服务器解析请求，定位请求资源。服务器将资源复本写到TCP套接字，由客户端读取。一个响应由状态行、响应头部、空行和响应数据4部分组成。

**4、释放连接[TCP连接](http://www.jianshu.com/p/ef892323e68f)**

若connection 模式为close，则服务器主动关闭[TCP连接](http://www.jianshu.com/p/ef892323e68f)，客户端被动关闭连接，释放[TCP连接](http://www.jianshu.com/p/ef892323e68f);若connection 模式为keepalive，则该连接会保持一段时间，在该时间内可以继续接收请求;

**5、客户端浏览器解析HTML内容**

客户端浏览器首先解析状态行，查看表明请求是否成功的状态代码。然后解析每一个响应头，响应头告知以下为若干字节的HTML文档和文档的字符集。客户端浏览器读取响应数据HTML，根据HTML的语法对其进行格式化，并在浏览器窗口中显示。

 

######  九.GET和POST的区别    

   1、GET提交的数据会放在URL之后，以?分割URL和传输数据，参数之间以&相连，如EditPosts.aspx?name=test1&id=123456. POST方法是把提交的数据放在HTTP包的Body中.

   2、GET提交的数据大小有限制（因为浏览器对URL的长度有限制），而POST方法提交的数据没有限制.

   3、GET方式需要使用Request.QueryString来取得变量的值，而POST方式通过Request.Form来获取变量的值。

   4、GET方式提交数据，会带来安全问题，比如一个登录页面，通过GET方式提交数据时，用户名和密码将出现在URL上，如果页面可以被缓存或者其他人可以访问这台机器，就可以从历史记录获得该用户的账号和密码.

# JS进阶06    node.js的安装及操作

**Node.js® 是一个基于 Chrome V8 引擎 的 JavaScript 运行时环境,是一个事件驱动I/O服务端JavaScript环境,V8引擎执行Javascript的速度非常快，性能非常好。**

##### 1-常用命令：

**<u>黑窗口的打开方式</u>**①window+R②电脑地址栏输入cmd③搜索cmd④vscode终端;苹果电脑->其他终端

**<u>window系统</u>**->命令提示符 / DOS命令：

dir 	显示文件列表	

**cd**   切换当前工作目录	

​		cd         文件夹 （进入文件夹）	

​		**cd ..**	 (进入上一级文件夹)

在c盘,输入d盘的话输入    d:      即可

**cls**    清屏

**ipconfig**    获取ip配置

**ping**   +ip地址-->测试ip连接状态

**ping攻击:**    ping -l 6550 -t ip地址

**<u>mac系统</u>**->      ls   打开文件目录

##### 2-node.js简介

[Node.js 简介 (nodejs.cn)](http://nodejs.cn/learn)

*Node*.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。

*Node*.js 使用了一个事件驱动、非阻塞式 I/O 的模型,使其轻量又高效

*Node*.js 的包管理器 npm,是全球最大的开源库生态系统。



I/O ：input /output	输入/输出   请求/应答	



##### 3、安装配置 node 环境

1、下载node 安装包 http://nodejs.cn/download/

2、安装node

​	注意：默认安装 --  add to path

3、测试是否安装成功

​	1） window+r 		cmd		

​			node  -v		查看node 版本号

   2）任何目录下 执行 node 

​		打开文件资源管理器 -- 进入 目录 	--- 地址栏 选中所有 -- 删除  --- cmd 回车

​		node  -v	

  3）编辑器中测试

​		vscode -- 在终端测试

​		node -v 

​		如果有错  首先 重启编辑器 测试

​		如果还有错参考 https://blog.csdn.net/qq_45611467/article/details/109403426  解决

​		

##### 4-node 执行 js 代码

node  文件路径

```
node ./1.js
```

##### 5-node 交互解释器	

node  回车

```
node

>
```



终止任务  **俩次   Ctrl+C**  或者  **Ctrl+D**  

##### 6-node 搭建 http 服务器

http.js

```js
var http =require("http");
http.createServer(function(req,res){
  res.write("hello world");
  res.write("hello gao");

  res.end(); // 一定要有 end();

}).listen(3000)

```

```
*//下面的端口不能用*

*//80 http*

*//443  https*

*//3306  mysql*

*//21 ssh*

*//22  ftp*

*//27017  mongodb*
```

运行

```
node ./http.js
```

终止

```
终止任务  俩次   Ctrl+C  或者  Ctrl+D 
```

##### 7-请求

1、 地址

本机地址：

http://127.0.0.1:3000

http://localhost:3000

班级 内网/局域网 地址

http://169.254.xx.xx:3000/

外网地址

租服务器（阿里云、百度云、腾讯云） --- 外网ip--- 绑定域名（备案）

2、内网/局域网 测试 http 服务时 。。 

​	  关闭 防火墙 



##### 8-npm 包管理器

**测试npm 是否 已安装** 

查看 版本号 ，如果能看到版本号，证明安装成功

```sh
npm  -v
```

初始化: 生成 模块依赖配置文件 

```sh
npm  init	一路回车
省略写法  npm init  -y
```

###### **1、下载**

添加到  项目依赖中 dependencies 

```sh
npm  install  模块名	
											--save
											-S
```

添加到 开发依赖 devDependencies	

```sh
npm install  模块名 --save-dev

										-D			
```

根据 依赖文件 package.json 下载依赖模块

```sh
npm install 
```

下载全局模块 

```sh
npm install  模块名  -g

g === global ===全局
```

###### **2、卸载**

卸载局部模块

```sh
npm uninstall 模块名
```

卸载全局模块

```sh
npm uninstall -g 模块名
```

###### **3、如何加速 npm 下载速度**

使用阿里 的 镜像

第一种办法： 使用 cnpm

```sh
npm install cnpm -g --registry=https://registry.nlark.com

命令都变为
cnpm install 模块名
cnpm uninstall 模块名
```

第二种办法: 只修改改 npm 下载路径 -- >cnpm 

```sh
npm config set registry  http://registry.npm.taobao.org
```

##### 9-模块分类--核心模块/ 内置模块**

######        9-1 **http  请求应答服务模块**

创建add.js,代码如下:

```javascript
// 创建模块
function sum(a,b){ console.log(a+b);   }
function jian(a,b){ console.log(a-b);  }

// 导出模块
module.exports={ sum, jian  }

```

​       在另一个js文件引入

```javascript
// 载入模块*
var obj = require("./add.js");

*// 使用模块*
obj.sum(3,4);
obj.jian(3,4);
```

######  9-2    fs文件系统模块

```javascript
//文件操作
// 载入 核心模块 fs 

var fs= require("fs");
// 读取

// 同步读取文件

    var x= fs.readFileSync("./01.txt");
    console.log(x.toString());

// 异步读取文件

    fs.readFile("./01.txt",function(err,data){
        console.log("err",err);
        console.log("data",data.toString());
    })


// 写入

//同步写入

    var y= fs.writeFileSync("./01.txt","789");
    console.log(y); // 没有返回值


// 异步写入

    fs.writeFile("./01.txt","xyz",function(err){
        console.log("err",err);
    })


// 删除

// 同步删除
 fs.unlinkSync("./02.txt");

// 
fs.unlink("./02.txt",function(err){
    console.log(err);
})
```

######       9-3  url 处理模块

```javascript
var url=require("url");

// url.parse()      将url 字符串 转为 url 对象
var str="http://www.baidu.com:3000/search?a=1&b=2#xx";

var obj = url.parse(str,true); // 第二个参数 == true 将 query （a=1&b=2) 转为 对象{a:1,b:2} 

console.log(`url对象`, obj);
console.log(`主机名`, obj.hostname);
console.log(`路径名`, obj.pathname);
console.log(`搜索语句/条件`, obj.query);

```

######   9-4    queryString 模块

```javascript
var querystring=require("querystring");
// console.log(querystring);


var str="a=1&b=2&c=3";

// 将url query 字符串 转为 对象
var obj = querystring.parse(str);
console.log(obj);

// 将 对象 转为 url query 字符串
var s= querystring.stringify(obj);
console.log(s);

//-----------------------

var str= "a=哈哈哈&b=2";
// 编码 （汉字、特殊字符）
console.log( querystring.escape(str) )
var s="a%3D%E5%93%88%E5%93%88%E5%93%88%26b%3D2";
// 解码
console.log( querystring.unescape(s) );
```

​        ...

##### 10-switch case实现路由

路由：

当用户访问 http://127.0.0.1:3000    
===  http://127.0.0.1:3000/
     返回：这是主页

当用户访问 http://127.0.0.1:3000/user   
     返回：这是用户列表页面


当用户访问 http://127.0.0.1:3000/add   
     返回：这是添加用户列表页面


当用户访问 http://127.0.0.1:3000/其他 
     返回：没有找到这个页面

思路
1、创建服务器
2、获取 请求地址 
3、通过 请求地址 得到 pathname
4、通过pathname 判断 -- 显示对应的 内容

```javascript
const http=require("http");
const url=require("url");
const fs= require("fs");
http.createServer(function(req,res){
    // 网页编码 -- utf8
    res.writeHead(200, {
        'content-type': 'text/html;charset=utf8'
    });
    //req.url 请求地址
    var pathname=url.parse( req.url ).pathname;
    switch(pathname){
        case "/":
            res.end("this is main page哈哈");
            break;
        case "/user":
            res.end("this is user page");
            break;
        case "/add":
            // res.end("this is add page");
            fs.readFile("./add.html",function(err,data){
                res.end(data);
            })  
            break;
        default:
            res.end("404");
            break;
    }
}).listen(3000)
```

##### 

# JS进阶07    数据接口

数据格式为json

请求地址:

请求方式:

请求参数:

响应数据:

##### 1    数据接口1   switch  case实现路由

步骤:

1、 创建服务器 --- 测试
2、 通过pathname  实现 路由 --- 测试

3、 创建默认数据

4、 实现 所有商品信息 接口
5、 返回搜索商品
    5-1、获取 query 值
    5-2、filter
    5-3、 返回 过滤后的值

6、添加
    6-1、获取 post 传值
     

```javascript
var post ="";
req.on("data",function(v){ post +=v  })
req.on("end",function(v){ console.log( data );...})

const http = require("http");
  //载入url模块
const url = require("url");
const querystring= require("querystring");
var arr=[
  {"id":1,"name":"苹果","price":100},
  {"id":2,"name":"大苹果","price":200},
  {"id":3,"name":"小苹果","price":300},
  {"id":4,"name":"橘子","price":400},
  {"id":5,"name":"砂糖橘","price":500}
]

http.createServer(function (req, res) {
    //处理汉字乱码
  res.writeHead(200, {
    'content-type': 'text/html;charset=utf8'
  });
  const pathname = url.parse(req.url).pathname;
  switch (pathname) {
//------------------------------------------
/*地址前缀：http://127.0.0.1:3000
接口1、所有商品信息
请求地址：  /goodsList
请求方式：  GET
请求参数/入参：
响应数据/出参：
成功：{"code":"ok", "info":[ {"id":唯一索引,"name":商品名,"price":商品价格}  ] */ 
//-------------------------------------------
    case "/goodsList":
      var goodsList={
        "code":"ok",
       "info":arr
      }
      res.end( JSON.stringify( goodsList ) );
      break;
//----------------------------------------------
/*接口2、返回搜索商品
请求地址：/search
请求方式：GET
请求参数/入参：name=?
响应数据/出参：
成功：{ "code":"ok","info":[ { "id":唯一索引,"name":商品名,"price":商品价格 }  ]  }
失败: {  "code":"no","msg":"服务器出错" }*/
//---------------------------------------
    case "/search":
     var name = url.parse( req.url ,true ).query.name;
      var searchArr= arr.filter(function(v){
        return v.name.includes( name )
      })
      *// console.log(name, searchArr)*
      var search={
        "code":"ok",
        "info":searchArr
      }
      res.end(JSON.stringify(search));
      break;
//------------------------------------------------
/*接口3、添加商品
请求地址：  /add
请求方式：  POST
请求参数/入参：name=? price=?
响应数据/出参：
成功{"code":"ok"}
失败:{"code":"no","msg":"服务器出错"}*/
//----------------------------------------------------
    case "/add":
      *// 1、创建 暂存变量*
      var post ="";
      *// 2、监听 数据 - 拼接 字符串*
      req.on("data",function(v){
        post += v;
      })
      *// 3、监听 请求结束* 
      req.on("end",function(){
        console.log(post); *// url 字符串*
        *// 转为 对象*
        var postObj= querystring.parse( post );
        *// 判断 如果 有值*
        if( postObj.name && postObj.price ){
          *// push 到 数组中*
          arr.push( {"id":new Date().getTime(),"name":postObj.name,"price":postObj.price} );
          *// 返回 正确*
          res.end(JSON.stringify( {"code":"ok"} ));
        }else{
          *// 没有值，返回 错误*
          res.end(JSON.stringify( {"code":"no","msg":"参数有问题"} ));
        }
      })
      break;   

    default:
      res.end("其他")
      break;
  }
}).listen(3000)
```

##### 2   数据接口2:

步骤:

**一、创建 服务器**

**二、通过 pathname 实现路由**

**三、模拟数据 --- （连接数据库）**

**四、写接口**

```javascript
const http = require("http");
const url = require("url");
const querystring = require("querystring");

var arr = [{"id": 1,"user": "高1","age": 18},
    {"id": 2,"user": "高2","age": 19},
    {"id": 3,"user": "高3","age": 20},
    {"id": 4,"user": "高4","age": 21},
    { "id": 5,"user": "高5","age": 22}]
//一、创建 服务器
//二、通过 pathname 实现路由
//三、模拟数据 --- （连接数据库）
 //四、写接口
http.createServer(function (req, res) {
    // 解决跨域-- 添加响应头
    res.setHeader('Access-Control-Allow-Origin', "*");
    res.writeHead(200, {'content-type': 'text/html;charset=utf8'});
    const pathname = url.parse(req.url).pathname;
 
    switch (pathname) {
   /*      前缀： http://127.0.0.1:3000
        1、所有用户数据        
            请求地址： /list
            请求方式： GET
            上传数据：
            响应数据：{ "code":"ok/no" , "info":[ {} ] } */
        case "/list":
            var list = {
                "code": "ok",
                "info": arr
            }
            res.end(JSON.stringify(list));
            break;
    /*2、添加用户信息
    请求地址：/add
    请求方式：POST
    上传数据：user=姓名 age=年龄
    响应数据：
    { "code":"ok/no" } */
        case "/add":
            var post = "";

            req.on("data", function (v) {
                post += v;
            })

            req.on("end", function () {
                // console.log(post);
                var addObj = querystring.parse(post);
                if (addObj.user && addObj.age) {
                    arr.push({
                        "id": new Date().getTime(),
                        "user": addObj.user,
                        "age": addObj.age
                    })

                    res.end(JSON.stringify({
                        "code": "ok"
                    }));
                } else {
                    res.end(JSON.stringify({
                        "code": "no",
                        "msg": "参数不对"
                    }));
                }
            })
// res.end("add");
            break;
    /* 3、删除用户信息
    请求地址：/del?id=1
    请求方式：GET
    上传数据：id=
    响应数据：
    { "code":"ok/no" } */
        case "/del":
            var id = url.parse(req.url, true).query.id;
            var index = arr.findIndex(v => v.id == id);

            if (index == -1) {
                res.end(JSON.stringify({
                    "code": "no"
                }));
            } else {

                arr.splice(index, 1);
                res.end(JSON.stringify({
                    "code": "ok"
                }));
            }
            break;
        default:
            res.end("其他");
            break;
    }

    // res.end("服务器创建成功");
}).listen(3000)
```



##### 3   json-p实现百度搜索显示

```javascript
function show(res){
            console.log(res);
            var str="";
            res.s.forEach(function(v){
                str+=`
                <li>${v}</li>
                `
            })
            document.getElementById("ul").innerHTML=str;
        }
var sDom=document.getElementById("s");
            sDom.onkeyup=function(){ 
                var x= this.value;
                if(x){
                    var scriptDom= document.createElement("script");
                    scriptDom.src= `https://suggestion.baidu.com/su?wd=${x}&cb=show`;
                  document.body.appendChild( scriptDom );
                }
            }
```

##### 4  学员管理系统案例(  原生ajax  )

```javascript
// mock 模拟数据，模拟请求   http://mockjs.com/
// 页面加载完成 请求 所有学员 数据接口 -- 渲染表格
    function getList(){
// 兼容ie5 ie6 https://www.runoob.com/ajax/ajax-xmlhttprequest-create.html
             var xhr=new XMLHttpRequest();
             xhr.open("GET","http://127.0.0.1:3000/list",true);
             xhr.send();
             xhr.onreadystatechange=function(){
                 if(xhr.readyState ==4 && xhr.status==200 ){
                    // console.log( xhr.responseText ); // 出现 --跨域 -- 后端

                    var obj= JSON.parse( xhr.responseText );
                    // 请求得到数据后 调用 渲染页面方法 showList()
                    showList(obj.info);
                 }
             }        
    }
    function showList(arr){
        // console.log("--",arr);
        var str="";
        arr.forEach(function(v,i){
            str+=`
            <tr>
                <td>${v.user}</td>
                <td>${v.age}</td>
                <td>
                    <button onclick="del(${v.id})">删除</button>
                </td>
            </tr>
            `
        })
        document.getElementById("tbody").innerHTML=str;
    }

    window.onload=function(){
        getList();
    }
    //  点击删除 --获取 id ---- 调用接口 将 id 传递给 --- 后端 --- 通过id --删除
    function del(id){
        var xhr= new XMLHttpRequest();
            xhr.open("GET",`http://127.0.0.1:3000/del?id=${id}`,true);
            xhr.send();
            xhr.onreadystatechange=function(){
                if(xhr.readyState ==4 && xhr.status==200){
                    // console.log( xhr.responseText )
                    var obj= JSON.parse( xhr.responseText );
                    if(obj.code == "ok"){
                        getList();
                    }else{
                        alert("删除失败，稍后试试");
                    }
                }
            }
    }
    //  -- 成功 -- 调用请求 所有学员 数据接口 -- 渲染表格
    //  -- 失败 -- 提示。。。。

    // 点击添加 -- 获取 表单输入值--- 调用接口 --- 后端-- 保存 
    var addDom=document.getElementById("add");
        addDom.onclick=function(){
            var userDom=document.getElementById("user");
            var ageDom=document.getElementById("age");

            var user= userDom.value;
            var age = ageDom.value;

            // console.log(user, age);

            var xhr=new XMLHttpRequest();
                xhr.open("POST","http://127.0.0.1:3000/add");

                // post 请求
                xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded")
                xhr.send(`user=${user}&age=${age}`);

                xhr.onreadystatechange=function(){
                   if(xhr.readyState==4 && xhr.status==200){
                        var obj= JSON.parse( xhr.responseText );
                        // console.log(obj);
                        if(obj.code =="ok"){
                            getList();
                        }else{
                            alert("添加失败，联系管理员");
                        }
                   } 
                }
        }

    //  -- 成功 -- 调用请求 所有学员 数据接口 -- 渲染表格
    //  -- 失败 -- 提示。。。。
```



# JS进阶08----express框架及Ajax的简单封装

安装node.js的框架express,其封装了http的方法,基于express还有koa 和egg

##### 1--数据接口

```javascript
const express= require("express");
const app=express();

//send
// req  .query   获取 url query 并转为对象  --- 获取get传参数
//  ? a =1 &b=2 ---- > {a:1,b:2}

app.get("/",function(req,res){
    console.log( req.query )
    res.send({"name":"gao"})
})

app.get("/user",function(req,res){
    res.send("get---user");
})
// post 
//req.body  接受 post 传参数

// post 值 转为json 格式
app.use( express.json() ); 
// 以 application/x-www-form-urlencoded 解析 post 参数
app.use( express.urlencoded({extended:true}) );

app.post("/add",function(req,res){
    console.log( req.body );
    res.send("add");
})
app.put("/user",function(req,res){
    res.send("put--user")
})
app.listen(3000);
```



##### 2     原生ajax            简单封装Ajax

post与get请求方式,传参方式,等不同

```javascript
function ajax(obj){
	var type = obj.type ? obj.type  :"GET" ;// 请求方式
  var url  = obj.url; // 	请求地址  /search
  var data = obj.data; // 请求数据	-- {a:1,b:2}
  var success= obj.success;

  var str="";
  for(var key in data){
    	str+=`${key}=${data[key]}&`
  }
  data= str.substr(0,str.length-1);
  var xhr= new XMLHttpRequest();
    
    //get传参方式
  if(type == "GET"){
     	xhr.open("GET",url+"?"+data,true); 
     	xhr.send();
    
   }else{
       
       //post传参
     	xhr.open("POST",url,true); 
     	xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
      xhr.send(data);
   }

   xhr.onreadystatechange=function(){
     if(xhr.readyState ==4 && xhr.status==200){
       var data= JSON.parse( xhr.responseText );
       success( data );
     }
   } 
}
```

##### 3  商品前台--后台分离管理案例(   模拟数据,为连接服务器,    添加--删除--排序功能) 

```javascript
//---------服务器js文件--------------
// 服务器 js 文件 -- 实现数据接口

const express =require("express");

const app=express();
//post传参固定语法
app.use( express.json());
app.use( express.urlencoded({extended:true}) );

// 发布静态资源
app.use( express.static("public") )

// 测试服务器 是否创建成功
// app.get("/",function(req,res){
//     res.send("111")
// })

var arr=[
    {
        "id":1,
        "goodsName":"苹果",
        "price":10,
        "num":1,    
    },
    {
        "id":2,
        "goodsName":"橘子",
        "price":9,
        "num":2, 
    },
    {
        "id":3,
        "goodsName":"香蕉",
        "price":8,
        "num":2, 
    },
    {
        "id":4,
        "goodsName":"西瓜",
        "price":2.5,
        "num":2, 
    }
]
//------------------------------
//1、添加数据接口如下 
/* 1、添加数据接口如下 
    请求地址：http://127.0.0.1:3000/add
    请求方式：POST
    上传参数：goodsName 、 price 、num
    响应数据：{ "code":"ok /no" } */
//---------------------------------------
app.post("/add",function(req,res){
    var obj= req.body;
    if(obj.goodsName && obj.price && obj.num){
        arr.push(
            {
                "id":new Date().getTime(),
                "goodsName":obj.goodsName,
                "price": Number(obj.price),
                "num":Number(obj.num),    
            }
        )
        res.send( { "code":"ok"} );

    }else{
        res.send( { "code":"no","msg":"参数有问题" } ); 
    }
})
//-----------------------------------------
// 2、获取数据接口如
/* 2、获取数据接口
    请求地址：http://127.0.0.1:3000/all
    请求方式：GET
    上传参数：
    响应数据：{ "code":"ok /no" ,"info":[ {} ] } */
//---------------------------------------------
app.get("/all",function(req,res){
    res.send( { "code":"ok","info":arr } )
})
//------------------------------------------
// 3、删除数据接口
/* 3、删除数据接口
    请求地址：http://127.0.0.1:3000/del
    请求方式：GET
    上传参数：id=？
    响应数据：{ "code":"ok /no" } */
//-----------------------------------------------
app.get("/del",function(req,res){
    var id = req.query.id;
    var index= arr.findIndex(v=>v.id == id);
    if(index ==-1){
        res.send( { "code":"no","msg":"删除失败" } );
    }else{
        arr.splice(index,1);
        res.send( { "code":"ok"} )
    }
})
//--------------------------------------------

/* 4、 价格从高到低
 请求地址：http://127.0.0.1:3000/desc
 请求方式：GET
 上传参数：
  响应数据：{ "code":"ok /no" ,"info":[ {} ] } */
//-------------------------------------------
app.get("/desc",function(req,res){

    var x = arr.sort(function(a,b){
        return b.price-a.price 
    })

    res.send( {"code":"ok","info":x } )
})
//--------------------------------------------------
// 5、 价格从低到高
 /*请求地址：http://127.0.0.1:3000/esc
 请求方式：GET
 上传参数：
响应数据：{ "code":"ok /no" ,"info":[ {} ] } */
//----------------------------------------------------
app.get("/esc",function(req,res){

    var x = arr.sort(function(a,b){
        return a.price -b.price
    })

    res.send( {"code":"ok","info":x } )
})
app.listen(3000);
```



```javascript
//-------后台js文件-----------
// 封装 ajax 请求 函数
/*type 请求方式  GET /POST
url  请求地址   */
function ajax(obj){
    var xhr= new XMLHttpRequest();
        xhr.open(obj.type,obj.url,true);
        // xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");      
        xhr.send();
        xhr.onreadystatechange=function(){
            if(xhr.readyState ==4 && xhr.status==200){
                var data= JSON.parse( xhr.responseText );
                // console.log(data);
                // return data;
                obj.success( data );
            }
        } 
}

//  ajax( "GET","/all" ,function(res){
//     console.log(res);
//  });

//  ajax({
//      type:"GET",
//      url:"/all",
//      success:function(res){
//         console.log(res);
//      }
     
//  })

//1、请求数据 -渲染页面
function getList(){    
        ajax( {
            type:"GET",
            url:"/all",
            success:function(res){
                // console.log(res);
                showList(res.info)
            }
        })
// 请求得到数据后 调用 渲染页面方法 showList()
}   
//渲染页面
function showList(arr){
    var str="";
    arr.forEach(function(v){
        str+=`
        <tr>
            <td>${v.id}</td>
            <td>${v.goodsName}</td>
            <td>${v.price}</td>
            <td>${v.num}</td>
            <td>${ (v.price *v.num).toFixed(2) }</td>
            <td>
                <button onclick="del(${v.id})">删除</button>
            </td>
        </tr>
        `
    })

    document.getElementById("tbody").innerHTML=str;
}

window.onload=function(){
    getList();
}

//2、 删除
function del(id){
    // var xhr= new XMLHttpRequest();
    //     xhr.open("GET",`/del?id=${id}`,true);
    //     xhr.send();
    //     xhr.onreadystatechange=function(){
    //         if(xhr.readyState ==4 &&xhr.status ==200 ){
    //             var obj= JSON.parse( xhr.responseText );
    //             // console.log(obj);
    //             if(obj.code == "ok"){
    //                     getList();
    //             }
    //         }
    //     }


    ajax({
        type:"GET",
        url:`/del?id=${id}`,
        success:function(res){
            if(res.code == "ok"){
                getList();
            }
        }
    })

}

//3、添加

var addDom=document.getElementById("add");
    addDom.onclick=function(){
        // 获取 表单 节点
        var goodsNameDom= document.getElementById("goodsName");
        var priceDom= document.getElementById("price");
        var numDom= document.getElementById("num");

        // 获取 表单 值
        var goodsName=goodsNameDom.value;
        var price=priceDom.value;
        var num=numDom.value;

        // ajax -- 表单值 --- 后端

        var xhr= new XMLHttpRequest();
            xhr.open("POST","/add",true);
            xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"); 

            xhr.send(`goodsName=${goodsName}&price=${price}&num=${num}`);
            xhr.onreadystatechange=function(){
                if(xhr.readyState ==4 && xhr.status ==200){
                    var obj=JSON.parse( xhr.responseText );
                    // console.log(obj);
                    if(obj.code == "ok"){
                        getList();
                    }
                }
            }
        // ok -- 调用 获取数据 方法
 
    }

```

```javascript
//-------------前台js文件-----------
function ajax(obj) {
            var xhr = new XMLHttpRequest();
            xhr.open(obj.type, obj.url, true);
            // xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");      
            xhr.send();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var data = JSON.parse(xhr.responseText);
                    // console.log(data);
                    // return data;
                    obj.success(data);
                }
            }
        }


        function getList(s) {
            var e = event || window.event;
            if (e.target.tagName == "LI") {
                // 获取所有li 
                var lis = document.getElementById("tab").children;
                // console.log(lis);

                for (var i = 0; i < lis.length; i++) {
                    lis[i].classList.remove("li_active");
                }

                e.target.classList.add("li_active");
            }
            ajax({
                type: "GET",
                url: `/${s}`,
                success: function (res) {
                    // console.log(res);
                    showList(res.info);
                }
            })
        }

        function showList(arr) {
            var str = "";
            arr.forEach(function (v) {
                str += `
                <div class="item">
                    <p class="item_name">${v.goodsName}</p>
                    <div class="item_msg">
                        <p>单价：${v.price}</p>
                        <p>数量：${v.num}</p>
                        <p>小计：</p>
                    </div>
                </div>
                `
            })
            document.getElementById("list").innerHTML = str;
        }

        window.onload = function () {
            getList("desc")
        }
```

  

# JS进阶09    jquery封装的Ajax 及数据库mongoose

##### 1-jquery  封装的ajax

测试 jquery ajax

```javascript
//简单易用的高层实现见 $.get, $.post 等
$.get("http://169.254.44.235:3000/one",function(res){console.log(res);})
    $.ajax({
      type:"GET",//请求方式
      url:"http://169.254.44.235:3000/two",// 请求地址
       headers:{},    // 设置请求头
            
      data:{a:2,b:2}, 
      success:function(res){  console.log(res);}, // 请求成功 回调函数
      dataType:"text", *// 返回值的数据格式/类型 -- 默认json ，
     
      error:function(){ console.log("错误了"); },//请求失败/错误 回调函数
      beforeSend:function(){ console.log("正在请求");// 请求前  loading 效果 、请求拦截
        *// return false; //4*
      },
    
      timeout:3000, *//请求超时时间  
       cache:true ,    //true 缓存 false 不缓存
    })
//简单用法,不用配置
 $.get("http://169.254.44.235:3000/two",{"a":1,"b":2},function(res){console.log(res) },"text");
        // $.get( 请求地址, 上传参数, 成功回调，返回值的数据类型 )
 $.post("http://169.254.44.235:3000/three",function(res){ console.log(res)})    $.post("http://169.254.44.235:3000/four",{x:2,y:4},function(res){ console.log(res)})
     

```

##### 2-数据库

###### 关系型 : 

 甲骨文【mysql  oracle 】、微软【sql server】 、sql lite

操作语言：sql

概念： 数据库    表   字段

**增:insert into 表名(字段1,字段2) values(值1,值2)**

**删:delete form 表名 where 条件(字段===字段)**

**改:update 表名 set 字段=新值 where  条件(字段=字段)**

**查:select *form  "表名"**

表现形式：

1用户信息表

| id   | name | Age  | gid(外键） |
| ---- | ---- | ---- | ---------- |
| 1    | gao  | 19   | 1，2       |
| 2    | Wang | 18   | 3          |
| 3    | Li   | 17   | 4          |

2用户订单表

| Id   | goodsName        |
| ---- | ---------------- |
| 1    | 苹果、橘子、香蕉 |
| 2    | 手机             |
| 3    | 水杯             |
| 4    | 电脑             |



###### 非关系型:redis 、mongodb

概念： 数据库	 集合   文档

表现形式：

用户信息集合

```
{ "id":1,"name":"gg" }

{ "id":1,"name":"gg","age":19 }

{ "id":1,"name":"gg","age":19 ,hobby:[]}
```



用户订单集合

##### 3-数据库操作

###### 1、查看数据库

```shell
show databases;       或者     show dbs;
```

###### 2、创建数据库/使用数据库

```shell
use 数据库名；
例子:ues  school使用或者创建名为school数据库
```

###### 3、删除数据库 

```
use 数据库；
db.dropDatabase();
```

###### 4、创建集合

```shell
db.createCollection("集合名")
集合名:不能是数字开头

例子:db.createCollection("p3")创建名为p3的集合
```

###### 5、查看集合

```
show collections;或者   show tables;
```

###### 6、删除集合

```
db.[collection].drop()

例子:db.p2.drop();删除名为p2的集合
```

###### 7、插入文档

```
db.[collection].insert(  );

例子:db.p3.insert( {"name":"gao","age":18 } );
在p3的集合中插入文档
```

###### 8、查找

```
db.[collection].find()
或者
db.[collection].find().pretty()
```

###### 9、条件查找-等于

```
db.collection.find({key:"value"})

例子:
db.p3.find({"age":18});在p3中找年龄等于18的
```

###### 10、条件查找-大于/小于

```
db.[collection].find({key:{$gt:value} })
$gt大于    $lt小于
例子:
db.p3.find({"age"{$gt:18} });在p3中找年龄大于18的
```

###### 10、limit 、skip

```javascript
db.[collection].find().limit(n)	每次查询几条
db.[collection].find().skip(n)	跳过n条
例子:
db.p3.find().limit(2);在p3的集合查找每次查询2条->可以做分页
```

###### 11、修改

```javascript
db.[collection].update({条件},{修改值})
db.[collection].update({"name":"gao"},{"age":188}) //修改后结果 {"age":188}

或者
db.[collection].update({条件},{ $set:{"name":"zzzz"} })

例子:
db.p3.update({"name":wang},{$set:{"age":100}});修改p3的这集合中name为wang的这个数据,把age改为100
```

###### 12、删除

```javascript
db.[collection].remove({条件})

例子:db.p3.remove({"age":188})删除p3集合中的年龄188的这条数据
```

###### 13  mongoDB Compass

管理软件,在下方也可以写数据库增删改查命令,可导入json格式数据

###### 14 mysql

sql语句

```
**添加**  insert into`students`{"id",`name`,age,sex} values{null,高,12,男}
```



##### 4-node操作mongodb

**连接mongodb:使用模块mongoose连接mongodb**

```javascript
/*第一步:下载模块黑窗口命令*/ 
npm  install mongoose -D

/*第二步:载入模块*/
const mongoose=require("mongoose");

/*第三步:node.js连接mongodb数据库*/
    mongoose.connect("mongoose://127.0.0.1:27017/数据库名",
                     { useUnifiedTopology: true ,useNewUrlParser: true},function(err){
        console.log(err); // 没有错误 err === null
      });

/*第四步:创建集合骨架--规则/骨架*/
const studentsSchema= new mongoose.Schema({
    "name":String,
    "age" :Number,
    "hobby":Array,
    "sex":Boolean
})//studentsSchema为规则名/骨架名

/*第五步:创建数据集合模型*/
const studentsModel = mongoose.model( "students", studentsSchema);
/*const studentsModel = mongoose.model("参数1:集合名",参数2:规则名/骨架名)*/
                                     
/*第6步:增删改查*/
studentsModel.create()
```

增/删/改/查   下面案例

```javascript
//--------------文件connect.js--------------------------
// 连接mongoose--mongoose连接ip为127.0.0.1.27017/text--有则加载,无则创建

const mongoose = require("mongoose");
mongoose.connect("mongodb://127.0.0.1:27017/test", { useUnifiedTopology: true ,useNewUrlParser: true},function(err){ console.log(err); // 没有错误 err === null
});
module.exports=mongoose;//封装导出


//---------------文件studentsModel.js--------------------------
const mongoose= require("./connect.js");//封装引入
//创建数据模板--创建数据类型
const studentsSchema= new mongoose.Schema({
    "name":String,
    "age" :Number,
    "hobby":Array,
    "sex":Boolean
})
// 集合 -- 创建数据模型
const studentsModel = mongoose.model( "students", studentsSchema);

module.exports=studentsModel;//封装导出


//--------------------------------------------------
const  studentsModel =require("./studentsModel");//封装引入
// 查   find 、 findOne   注意: {}为查找所有数据
//分页 : 第几页  limit  每页显示条数    skip 跳过 n =(第几页-1)*limit 条
    studentsModel.find({},{"age":true},function(err,data){
        console.log("查询有错吗",err);
        console.log(data);
    })


//更改"_id":"60e6a4a244d3906d30159131"的这条数据,将name改为gao2222
// updateMany 修改多个
    studentsModel.updateOne({"_id":"60e6a4a244d3906d30159131"},{$set:{"name":"gao2222"}},function(err,data){
        console.log("查询有错吗",err);
        console.log(data);
    })

//deleteMany、deleteOne
//数据模型名.deleteOne( {删除条件},function(err,data){
       err 是错误信息, 没有错误 null 
       data:{n: 1, ok: 1, deletedCount: 1}
} )
```

##### 5-node 实现 数据接口

**流程:**

**1-用户注册 ：**

**2-前端：**


在 表单中 输入 用户名，密码， 点击 注册 ， 【html css ，js 事件】
将 用户的 输入值  提交 到 后端  【 ajax 】

1、写页面 +样式 +点击事件 - 获取 表单值 - ajax 。。 缺了 接口
------等待后端 1，2，3---
2、ajax 请求



**3-后端；**
用户 输入网址 打开 注册页面 ，
--后端 将数据 保存到数据库 【 node + mongodb】

1、实现服务器
2、发布静态资源 -页面
3、实现 数据接口
    请求地址：/add
    请求方式：POST
    上传参数：user password
    响应数据：{"code":"ok/no"}

3-1、数据要保存在数据库中 
    所以：
        1、连接数据库
        2、创建 集合 规则
        3、创建 集合 数据模型
3-2、 实现post 接口
    1 、获取 post 值
    2、 将值 保存到 数据库
    3、 如果正确 返回 {"code":"ok"} 错误 返回{"code":"no"}

3-3、postman 测试接口 



**自 Express 4.16.0 版本开始，Express 内置了 3 个常用的中间件**
**express.static 快速托管静态资源的内置中间件，例如： HTML 文件、图片、CSS 样式等（无兼容性）**
**express.json 解析 JSON 格式的请求体数据（有兼容性，仅在 4.16.0+ 版本中可用）**
**express.urlencoded 解析 URL-encoded 格式的请求体数据（有兼容性，仅在 4.16.0+ 版本中可用）**

**(post请求的数据在请求体内,所以需要下面两个配置后才能正常获取)**

# JS进阶10    案例

###### 



###### 1-电器管理平台(增,删,排序)

```javascript
//----------API.js(应用接口文件-)--------
//1创建服务器

const express=require("express");
const app=express();

//解决跨域问题
 const cors=require("cors");
 app.use(cors());

//post传参
app.use(express.json());
app.use(express.urlencoded({extended:true}));

//1发布静态页面

app.use(express.static("public"));
//2连接数据库
const mongoose=require("mongoose");
mongoose.connect("mongodb://127.0.0.1:27017/p0709", { useUnifiedTopology: true,useNewUrlParser: true})
//2规则
const goodsSchema=new mongoose.Schema({
    name:String,
    price:Number,
    num:Number
})
//2建集合
const goodsModel=mongoose.model("goods",goodsSchema);
//3添加端口
/* 3-1、添加 商品
请求地址：/add
请求方式：POST
上传参数：name 、 price 、 num
响应数据：{ code : "ok/no" } */

app.post("/add",function(req,res){
    //对象解构
    let {name,msg,num}=req.body;

    //验证数据name msg num是否合规,插入数据库
    goodsModel.create({name,msg,num},function(err,data){
       if(err){
           res.send({"code":"no","msg":"添加失败"});
       }else{
           res.send({"code":"ok","info":data})
       }
    })
})
//

/* 3-2、返回所有商品数据
请求地址：/list
请求方式：GET
上传参数：
响应数据：{ code : "ok/no" ,"info":[] } */
app.get("/list",function(req,res){
    goodsModel.find({},function(err,data){
        if(err){
            res.send({"code":"no",});
        }else{
            res.send({"code":"ok","info":data})
        }
    })
})

/* 3-3、删除商品接口
请求地址：/del
请求方式：GET
上传参数：_id: 
响应数据：{ code : "ok/no" } */
app.get("/del",function(req,res){
    var _id=req.query._id;
    goodsModel.deleteOne({"_id":_id},function(err,data){
        if(err){
            res.send({"code":"no","msg":"删除错误"});
        }else{
            res.send({"code":"ok","info":data})
        }
    })
})


/* 3-4、返回商品数据 & 排序
请求地址：/listSort
请求方式：GET
上传参数：type :  -1 倒序/降序 价格 从高到低， 1 正序  价格 从低到高
响应数据：{ code : "ok/no" ,"info":[] } */

app.get("/listSort",function(req,res){
    var type=req.query.type;
    // esc  从 小到大   desc 从大到小
    // 1    从 小到大  -1 从大到小
    goodsModel.find({},{},{sort:{"price":type}},function (err,data) {
        if(err){
            res.send({"code":"no","msg":"排序错误"});
        }else{
            res.send({"code":"ok","info":data})
        }
    } )
})
//1
app.listen(3000);
```





```html
//--------后台页面----------------
<!-- 表单添加商品  表格展示 -->
    <form >
        <div>
            <label for="">商品名</label>
            <input type="text" id="name">
        </div>
        <div>
            <label for="">单价</label>
            <input type="text" id="price">
        </div>
        <div>
            <label for="">数量</label>
            <input type="text" id="num">
        </div>
        <div>
            <input type="button" value="添加" id="add">
        </div>
    </form>

    <table>
        <thead>
            <tr>
                <td>id</td>
                <td>商品名</td>
                <td>单价</td>
                <td>数量</td>
                <td>小计</td>
                <td>操作</td>
            </tr>
        </thead>
        <tbody id="tbody">
            <!-- <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>
                    <button>删除</button>
                </td>
            </tr> -->
        </tbody>
    </table>
   
```



```javascript
//---------后台页面js文件-------------------------

//后端完成后,进行ajax操作,请求数据渲染页面
// $.post("http://169.254.44.235:3000/four",{x:2,y:4},function(res){ console.log(res)})

//下面把http://127.0.0.1:3000进行字符串拼接,
var baseUrl="http://127.0.0.1:3000";

//ajax请求数据后调用渲染
        function getList(){
            //$.get为ajax请求数据
            $.get(`${baseUrl}/list`,function(res){
                 console.log(res)
                if(res.code =="ok"){
                    //调用渲染
                    showList( res.info )
                }
            })

          
        }
        //拼接
        function showList(arr){
            var str="";
            $.each(arr,(i,v)=>{
                //解构对象进行赋值
                let {_id,name,price,num} =v;
                str+=`
                <tr>
                    <td>${_id}</td>
                    <td>${name}</td>
                    <td>${price}</td>
                    <td>${num}</td>
                    <td>${ (price * num).toFixed(2)}</td>
                    <td>
                        <button onclick="del('${_id}')">删除</button>
                    </td>
                </tr>
                `
            })
            $("#tbody").html(str);
        }
  //页面加载完成后,就获取ajax请求数据,渲染页面
        $(function(){
            getList();
        })

        //删除时,需要通过ajax通过id进行删除
        function del(_id){
            //通过url传参,http://169.254.77.143:3000/del?_id=111表示,删除_id为111的那条数据
            $.get(`${baseUrl}/del`,{"_id":_id},function(res){
                // console.log(res)
                if(res.code == "ok"){
                    //删除后请求数据并渲染
                    getList();
                }
            })
        }
   
//点击添加按钮绑定事件,
        $("#add").click(function(){
            
            //获取name,price,num的值
            var name =$("#name").val();
            var price =$("#price").val();
            var num =$("#num").val();
//请求数据,添加赋值
            //通过post的body传参,需要输入name,price,num三个参数
            $.post(`${baseUrl}/add`,{name,price,num},function(res){
                if(res.code == "ok"){
                     //删除后请求数据并渲染
                    getList();
                }
            })

        })
```

###### 2-下午电器管理案例

案例优化1,解构赋值对象let {_id,name,price,num} =v;

案例优化2:jquery中的serialize()序列表表格内容为字符串,需要将input表单添加name值。

```javascript
//--------------后端js文件  api--------------

// 1、创建服务器  支持http 请求 应答
const express =require("express");
const app=express();

// 解决跨域 
const cors =require("cors");
app.use(cors());


app.use(express.json());
app.use(express.urlencoded({extended:true}));

// 2、静态资源发布 
app.use(express.static("public"))

// 连接数据库
const mongoose =require("mongoose");
mongoose.connect("mongodb://127.0.0.1:27017/p301",{ useUnifiedTopology: true ,useNewUrlParser: true});
// 集合 -规则
// 集合名： goods
//        文档：  img  图片地址 、msg  简介、 price 价格、type 类别
//               string          string       number   string

const goodsSchema= new mongoose.Schema({
    img:String,
    msg:String,
    price:Number,
    type:String
})
// 集合 --数据模型
const goodsModel= mongoose.model("goods",goodsSchema);

/*4-1、展示所有商品数据接口

请求地址：/list
请求方式：GET
上传参数：
 响应数据：
    {"code":"ok/no","info":[]}*/
app.get("/list",(req,res)=>{//不需要传参
    goodsModel.find({},(err,data)=>{
        if( err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok","info":data});
        }
    })
})
// 4-2、删除商品数据接口

app.get("/del",(req,res)=>{
    //get传参url地址中,地址中有query,输入_id的值
    var _id = req.query._id;
    
    goodsModel.deleteOne({"_id":_id},(err,data)=>{
        if( err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})

// 4-3、添加商品数据接口
app.post("/add",(req,res)=>{
    var obj= req.body;//post传参在body中
    goodsModel.create(obj,err=>{
        if( err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})
// 4-4、 修改数据接口 - 获取当前要修改的 商品信息
app.get("/edit",(req,res)=>{
    var _id = req.query._id;//get传参url地址中,地址中有query,输入_id的值

    goodsModel.findOne({"_id":_id},(err,data)=>{
        if( err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok","info":data});
        }
    })
})
//  4-5 、确认修改接口

app.post("/editOk",(req,res)=>{
    var obj= req.body;//post传参在body中
    goodsModel.updateOne({"_id":obj._id},{$set:obj},err=>{
        if( err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})
app.listen(3000)
```

```javascript
//-----------------前端js文件-----------
// const baseUrl="http://127.0.0.1:3000";
const baseUrl="";


function getList(){
    //本地 不用输入http://127.0.0.1:3000  ,直接输入/list
    $.get(`/list`,res=>{
        // console.log(res)
        if(res.code == "ok"){
            showList(res.info)
        }

    })
}


function showList(arr){
    var str="";
    $.each(arr,(i,v)=>{
        str+=`
        <tr>
                <td>
                    <img src="./images/${v.img}" alt="">
                </td>
                <td>${v.msg}</td>
                <td>$${v.price}</td>
                <td>${v.type}</td>
                <td>
                    <span onclick="edit('${v._id}')">修改 &emsp;</span>
                    <span onclick="del('${v._id}')">删除</span>
                </td>
            </tr>
        `
    })

    $("#showTbody").html(str)
}

$(function(){

    getList();
})


// 删除

function del(_id){
    $.get(`/del`,{"_id":_id},res=>{
        if(res.code == "ok"){
            getList();
        }
    })
}


// 添加

$("#add").click(function(){
    var data=  $("#addForm").serialize() ;

    $.post(`/add`,data,res=>{
        if(res.code == "ok"){
            getList();
        }
    })
    $("#img").val("")
    $("#msg").val("")
    $("#price").val("")

})


//定义全局变量,存储下标,在确认修改中使用
var edit_id;

// 点击 表格 中 修改 按钮
function edit(_id){
    $("#add").hide();
    $("#editOk").show();

    $.get(`/edit`,{"_id":_id},res=>{
        // console.log(res)
        let { _id,img,msg,price,type }= res.info;
        $("#img").val(img);
        $("#msg").val(msg);
        $("#price").val(price);
        $("#type").val(type);
        //全局变量赋值
        edit_id=_id;

    })
}
// 点击 确认修改 按钮
$("#editOk").click(function(){
   

    var data= $("#addForm").serialize() + `&_id=${edit_id}`;
    // console.log(data)
    $.post(`/editOk`,data,res=>{

        if(res.code == "ok"){

            getList();
            $("#add").show();
            $("#editOk").hide();
            //清空输入框
            $("#img").val("")
            $("#msg").val("")
            $("#price").val("")
        }

    })
})
```

# JS进阶11

熟练后,前后端一起写,写接口时,直接写



##### 11.1    学生信息管理系统案例--多条件模糊搜索

后端api.js文件

```js
const express =require("express");
const app= express();
// 2、 发布静态资源
app.use(express.static("public"));

// post
app.use( express.json() );
app.use( express.urlencoded({extended:true}) );

// 连接数据库
const mongoose =require("mongoose");
mongoose.connect("mongodb://127.0.0.1:27017/p30712",{ useUnifiedTopology: true ,useNewUrlParser: true} );

// 学员信息 集合 规则
const studentsSchema=new mongoose.Schema({
        name:String,
        sex:String,
        age:Number,
        address:String
})
// 学员信息 集合 数据模型

const studentsModel=mongoose.model("students",studentsSchema);

// 添加
app.post("/add",(req,res)=>{
    var obj = req.body;
    studentsModel.create(obj,(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})

// 查询 
app.get("/list",(req,res)=>{

    //单条件模糊搜索------------------
  /*   var name = req.query.name;
    
    var query={};
    if (name ){
        query= {"name":{$regex:regexp}}
    } */
//------------------------------------

     //多条件模糊搜索
     //获取前端传递的值
    var query = req.query;
     //搜索name和age,其中一个有值,另一个为空,则删除空值,搜索另一个
    for(var key in query){
        if( !query[key]){
            delete query[key];
        }
      // 根据 姓名 模糊搜索  
        if( key == "name"){
            var regexp=new RegExp(query[key],'i');
            query.name ={$regex:regexp};
        }

    }

    studentsModel.find(query,(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok","info":data});
        }
    })
})
// 删除
app.get("/del",(req,res)=>{
    var _id= req.query._id
    studentsModel.deleteOne({"_id":_id},(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})
// 通过_id 得到  要修改的值
app.get("/edit",(req,res)=>{

    var _id= req.query._id;

    studentsModel.findOne({"_id":_id},(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok","info":data});
        }
    })
})



// 修改
app.post("/editOk",(req,res)=>{
    var obj = req.body;
    studentsModel.updateOne({"_id":obj._id},{$set:obj},(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})

app.listen(3000)
```

前端js文件

```js
//tab切换
$("#tab >li").click(function () {
    $(this).addClass("tab_active").siblings().removeClass("tab_active");
    $("#tabBox >div").eq($(this).index()).addClass("div_active").siblings().removeClass("div_active");
})

//多条件搜索，搜索条件

var query={"name":"","age":""}

// 点击展示 -- 请求 数据 --渲染 表格

$("#showList").click(function () {

    getList();
})

//请求 数据
function getList(obj) {
    //obj为搜索参数,如果有参数,则为obj,如果参数为空,则请求全部数据
    obj= obj?obj:{};
    // console.log(obj)
    $.get("/list", obj,function (res) {
        // console.log(res);
        if (res.code == "ok") {
            // 数据请求成功 -- 渲染 表格
            showList(res.info)
        }
    })


}

// 渲染 表格
function showList(arr) {
    var str = "";
    if (arr.length > 0) {
        $("#table").show();
        $("#nodata").hide();


        $.each(arr, function (i, v) {
            str += `
            <tr>
                <td>${v.name}</td>
                <td>${v.sex}</td>
                <td>${v.age}</td>
                <td>${v.address}</td>
                <td>
                    <button onclick="del('${v._id}')">删除</button>
                    <button onclick="edit('${v._id}')">修改</button>
                </td>
            </tr>
        `
        })
        $("#list").html(str);
    }else{
        $("#table").hide();
        $("#nodata").show();
    }

   
}
//删除
function del(_id) {
    $.get("/del", { "_id": _id }, function (res) {
        if (res.code == "ok") {
            // 数据删除成功 
            getList();
        }
    })
}

//录入

$("#add").click(function(){
//    console.log( $("#addForm").serialize() );
    var data=  $("#addForm").serialize();
    $.post("/add",data,function(res){
        if(res.code == "ok"){
            alert("录入成功");
        }
    })


})
//点击修改 -- 显示 修改表单 -- 请求接口 -- 渲染默认值 
var editId;
function edit(_id){
    $("#tan").show();
    $.get("/edit",{"_id":_id},function(res){
        if(res.code == "ok"){
            $("#name").val( res.info.name );
            $("#editForm :radio").each(function(i,v){
                if( $(v).val() == res.info.sex ){
                    $(v).prop("checked",true);
                }
            })

            $("#age").val( res.info.age );
            $("#address").val(res.info.address);
            editId = res.info._id;
        }

    })
}

// 点击确认修改 -- 获取表单值 -- 调用接口 --- 清空表单--  隐藏修改表单
$("#editOk").click(function(){
    $("#tan").hide(); 
    var data= $("#editForm").serialize()+ `&_id=${editId}`;   
    // console.log(data)
    $.post("/editOk",data,function(res){
        if(res.code == "ok"){
           getList();
        }
    })
})

//点击 取消修改 --- 清空表单 --- 隐藏修改表单
$("#editNo").click(function(){
    $("#tan").hide(); 
})


//单条件搜索
$("#search").on("keydown",function(event){
    // console.log(event)
    if(event.keyCode == 13){
        var name =  $(this).val() ;
        getList({"name":name})
    }
})

//多条件搜索
$("#ss").click(function(){
    var name = $("#sname").val();
    var age = $("#sage").val();
    query.name =name;
    query.age= age;
    getList(query)
})
```

前端html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/index.css">
    <script src="./js/jquery.min.js"></script>
</head>
<body>
    <h1>学员管理系统</h1>
    <div class="content">
        <div class="left">
            <ul id="tab">
                <li class="tab_active" >录入</li>
                <li id="showList">展示</li>
            </ul>
        </div>
        <div class="right" id="tabBox">
            <!-- 录入的表单  -->
            <div class="div_active">  
                <form id="addForm">
                    <div>
                        <label for="">姓名</label>
                        <input type="text" name="name">
                    </div>
                    <div>
                        <label for="">性别</label>
                       <span>男</span> <input type="radio"  value="男" name="sex">
                       <span>女</span> <input type="radio"  value="女" name="sex">                       
                    </div>

                    <div>
                        <label for="">年龄</label>
                        <input type="text" name="age">
                    </div>

                    <div>
                        <label for="">籍贯</label>
                        <select name="address" id="">
                            <option value="陕西">陕西</option>
                            <option value="河南">河南</option>
                            <option value="河北">河北</option>
                            <option value="湖南">湖南</option>
                        </select>
                    </div>

                    <div>  
                        <input type="button" value="添加" id="add">
                    </div>

                </form>  
            </div>

            <!-- 展示的 表格 -->
            <div>
                <!-- 单条件搜索 -->
                <input type="text" placeholder="输入姓名搜索" id="search">

                <!-- 多条件搜索 -->
                <div>
                    <input type="text" placeholder="输入姓名搜索" id="sname">
                    <input type="text" placeholder="输入年龄搜索" id="sage">
                    <input type="button" value="搜索" id="ss">


                </div>

                <table id="table">
                    <thead>
                        <tr>
                            <th>姓名</th>
                            <th>性别</th>
                            <th>年龄</th>
                            <th>籍贯</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="list">
                        <!-- <tr>
                            <td>111</td>
                            <td>男</td>
                            <td>19</td>
                            <td>陕西</td>
                            <td>
                                <button>删除</button>
                                <button>修改</button>
                            </td>
                            
                        </tr> -->
                    </tbody>
                </table>
                <h1 id="nodata">暂无数据</h1>
            </div>

        </div>
    </div>

    <div class="tan" id="tan">
        <div class="tanBox">
            <form id="editForm">
                <div>
                    <label for="">姓名</label>
                    <input type="text" name="name" id="name">
                </div>
                <div>
                    <label for="">性别</label>
                   <span>男</span> <input type="radio"  value="男" name="sex" >
                   <span>女</span> <input type="radio"  value="女" name="sex">                       
                </div>

                <div>
                    <label for="">年龄</label>
                    <input type="text" name="age" id="age">
                </div>

                <div>
                    <label for="">籍贯</label>
                    <select name="address" id="address">
                        <option value="陕西">陕西</option>
                        <option value="河南">河南</option>
                        <option value="河北">河北</option>
                        <option value="湖南">湖南</option>
                    </select>
                </div>

                <div>  
                    <input type="button" value="确认修改" id="editOk">
                    <input type="button" value="取消" id="editNo">

                </div>

            </form>  
        </div>
    </div>


    <script src="js/index.js"></script>
</body>
</html>
```

前端css文件

```css
*{
    margin: 0;
    padding: 0;
    list-style: none;
}

.content{
    width: 100vw;
    display: flex;
}
.left{
    width: 20vw;
    /* border: 1px solid black; */
    /* min-height: 80vh; */
}
.left >ul {
    text-align: center;

}
.left >ul >li{
   height: 50px;
   background: chocolate;
   line-height: 50px;
   width: 100%;
   cursor: pointer;
   margin-bottom: 10px;
}
.left >ul > .tab_active{
    background: red;
    color: white;
}
.right >div{
    display: none;
}
.right> .div_active{
    display: block;
}

.tan{
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0,0, 0.5);
    position: absolute;
    top:0;
    left:0;
    display: none;
}
.tanBox{
    width: 300px;
    height: 300px;
    background: white;
    position: absolute;
    top: 50%;
    left:50%;
    transform: translate(-50%,-50%);
}
```



##### 11.2查询条件

模糊查询是数据库的基本操作之一，实现对给定的字符串是否与指定的模式进行匹配。如果字符完全匹配，可以用=等号表示，如果部分匹配可认为是一种模糊查询。在关系型数据中，通过SQL使用like ‘%fens%’的语法。那么在mongodb中我们应该如何实现模糊查询的效果呢

| 关键字        | 说明                                                     |
| ------------- | -------------------------------------------------------- |
| $or           | 或关系                                                   |
| $nor          | 或关系取反                                               |
| $gt           | 大于                                                     |
| $gte          | 大于等于                                                 |
| $lt           | 小于                                                     |
| $lte          | 小于等于                                                 |
| $ne           | 不等于                                                   |
| $in           | 在多个值范围内,后面跟数组                                |
| $nin          | 不在多个值范围内                                         |
| $all          | 匹配数组中多个值                                         |
| $regex        | 正则，用于模糊查询                                       |
| $size         | 匹配数组大小                                             |
| $maxDistance  | 范围查询，距离（基于LBS）                                |
| $mod          | 取模运算                                                 |
| $near         | 邻域查询，查询附近的位置（基于LBS）                      |
| $exists       | 字段是否存在                                             |
| $elemMatch    | 匹配内数组内的元素                                       |
| $within       | 范围查询（基于LBS）                                      |
| $box          | 范围查询，矩形范围                                       |
| $center       | 范围查询，圆形范围                                       |
| $centerSphere | 范围查询，球形范围                                       |
| $slice        | 查询字段集合中的元素（比如从第几个之后，第N到第M个元素） |

##### 11.3精准查询

```js
//Mongodb数据库表
const systemUser = require('../../models/user'); 
systemUser.find({name:'xiaoming'}).exec(function(err,rs){}
```

##### 11.3  单条件模糊搜索

```js
const reg = new RegExp(keyword, 'i') //不区分大小写
```



##### 11.4多条件模糊查询

```js
//Mongodb数据库表
const systemUser = require('../../models/user');
//前端传入的要查询的关键字
var name = req.query.name;
var page = req.query.page || 1; //当前页数
var limitNums = 10; //指定每一页查询的条数
page = parseInt(page);
var skipNums = (page - 1) * limitNums; //跳过指定数量
//正则匹配 i忽略大小写
var reg = new RegExp(name, "i");
var _filter = {
    //多字段匹配
    $or: [
        {name: {$regex: reg}},
        {description: {$regex: reg}},
        {owner: {$regex: reg}},
    ]
}
systemUser.find(_filter).
//跳过指定数量的数据
skip(skipNums).
//指定从MongoDB中读取的记录条数。
limit(limitNums).
sort({createTime:-1}).
exec(function(err,rs){}
```

##### 11.5模糊查询简介

MongoDB查询条件可以使用正则表达式，从而实现模糊查询的功能。模糊查询可以使用$regex操作符或直接使用正则表达式对象。

MongoDB使用$regex操作符来设置匹配字符串的正则表达式，使用PCRE(Pert Compatible Regular Expression)作为正则表达式语言。

regex操作符

{:{r e g e x : / p a t t e r n / ， regex:/pattern/，regex:/pattern/，options:’’}}

{:{r e g e x : ’ p a t t e r n ’ ， regex:’pattern’，regex:’pattern’，options:’’}}

{:{$regex:/pattern/}}

正则表达式对象

{: /pattern/}$regex与正则表达式对象的区别:

在KaTeX parse error: Expected '}', got 'EOF' at end of input: …达式对象，例如:{name:{in:[/^joe/i, /^jack/}}

在使用隐式的a n d 操 作 符 中 ， 只 能 使 用 and操作符中，只能使用and操作符中，只能使用regex，例如:{name:{$regex:/^jo/i, $nin:[‘john’]}}

当option选项中包含X或S选项时，只能使用KaTeX parse error: Expected '}', got 'EOF' at end of input: …egex，例如:{name:{regex:/m.*line/,$options:“si”}}

$regex操作符的使用

**$regex操作符中的option选项可以改变正则匹配的默认行为，它包括i, m, x以及S四个选项**，其含义如下

i 忽略大小写，{{$regex/pattern/i}}，设置i选项后，模式中的字母会进行大小写不敏感匹配。

m 多行匹配模式，{{r e g e x / p a t t e r n / , regex/pattern/,regex/pattern/,options:‘m’}，m选项会更改^和$元字符的默认行为，分别使用与行的开头和结尾匹配，而不是与输入字符串的开头和结尾匹配。

x 忽略非转义的空白字符，{:{r e g e x : / p a t t e r n / , regex:/pattern/,regex:/pattern/,options:‘m’}，设置x选项后，正则表达式中的非转义的空白字符将被忽略，同时井号(#)被解释为注释的开头注，只能显式位于option选项中。

s 单行匹配模式{:{r e g e x : / p a t t e r n / , regex:/pattern/,regex:/pattern/,options:‘s’}，设置s选项后，会改变模式中的点号(.)元字符的默认行为，它会匹配所有字符，包括换行符(\n)，只能显式位于option选项中。

使用$regex操作符时，需要注意下面几个问题:

i，m，x，s可以组合使用，例如:{name:{r e g e x : / j ∗ k / , regex:/j*k/,regex:/j∗k/,options:“si”}}

在设置索弓}的字段上进行正则匹配可以提高查询速度，而且当正则表达式使用的是前缀表达式时，查询速度会进一步提高，例如:{name:{$regex: /^joe/}

上面介绍的元字符可能就会让我们在查询的时候出现一些问题，比如有时候想要查询出所有带价格的模糊商品的时候用了.元字符进行模糊搜索，这时候会查询出来全部的数据；

这个时候就需要对模糊查询的条件进行一些操作，转义一下：
————————————————
版权声明：本文为CSDN博主「夏末的雪」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/PinelliaCool/article/details/108007184

##### 11.6如何判断一个对象为空对象

1.将json对象转化为json字符串，再判断该字符串是否为"{}"

```js
var data = {};
var b = (JSON.stringify(data) == "{}");
alert(b);//true
```

2.for in 循环判断

```js
var obj = {};
var b = function() {
for(var key in obj) {
return false;
}
return true;
}
alert(b());//true
```

3.jquery的isEmptyObject方法
此方法是jquery将2方法(for in)进行封装，使用时需要依赖jquery

```js
var data = {};
var b = $.isEmptyObject(data);
alert(b);//true
```

4.Object.getOwnPropertyNames()方法
此方法是使用Object对象的getOwnPropertyNames方法，获取到对象中的属性名，存到一个数组中，返回数组对象，我们可以通过判断数组的length来判断此对象是否为空
注意：此方法不兼容ie8，其余浏览器没有测试

```js
var data = {};
var arr = Object.getOwnPropertyNames(data);
alert(arr.length == 0);//true
```

5.使用ES6的Object.keys()方法
与4方法类似，是ES6的新方法, 返回值也是对象中属性名组成的数组

```js
var data = {};
var arr = Object.keys(data);
alert(arr.length == 0);//true
```

————————————————
版权声明：本文为CSDN博主「云_飞扬」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/qq_38627581/article/details/77353015



# JS进阶12

##### 案例1  考试题目kky邮箱 2个数据库集合

```js
//-----------api  js文件
const express = require("express");
const app =express();
app.use(express.static("public"));
app.use(express.json());
app.use(express.urlencoded({extended:true}));

const mongoose =require("mongoose");
      mongoose.connect("mongodb://127.0.0.1:27017/p3kao",{ useUnifiedTopology: true,useNewUrlParser: true } );
// 草稿箱
// user 收信人	 title 主题	msg内容 	time创建时间（时间戳）
const cgxsSchema=new mongoose.Schema({
    user:String,
    title:String,
    msg:String,
    time:Number//Number可写为Date.now
})
const cgxsModel= mongoose.model( "cgxs", cgxsSchema);

// ​通讯录
// user  收信人
const txlsSchema=new mongoose.Schema({
    user:String 
})
const txlsModel= mongoose.model( "txls", txlsSchema);

// 1、添加到草稿箱

app.post("/addCgx",(req,res)=>{
    var obj =req.body;
    
    cgxsModel.create(obj,(err,data)=>{
        if(err){
            res.send({"code":"no","msg":"添加失败"});
        }else{
            res.send({"code":"ok"});
        }
    })
})

// 2、 添加到通讯录

app.post("/addTxl",(req,res)=>{
    var user =req.body.user;

    txlsModel.create({"user":user},(err,data)=>{
        if(err){
            res.send({"code":"no","msg":"添加失败"});
        }else{
            res.send({"code":"ok"});
        }
    })
})
//3、 查询所有草稿箱数据
app.get("/listCgx",(req,res)=>{
    
    cgxsModel.find({},(err,data)=>{
        if(err){
            res.send({"code":"no","msg":"查询失败"});
        }else{
            res.send({"code":"ok","info":data});
        }
    })
})
// 4、删除	草稿箱一条数据
app.get("/delCgx",(req,res)=>{
    var _id= req.query._id;

    cgxsModel.deleteOne({"_id":_id},(err,data)=>{
        if(err){
            res.send({"code":"no","msg":"删除失败"});
        }else{
            res.send({"code":"ok"});
        }
    })
})
// 5 、清空草稿箱
app.get("/clearCgx",(req,res)=>{
  
    cgxsModel.deleteMany({},(err,data)=>{
        if(err){
            res.send({"code":"no","msg":"删除失败"});
        }else{
            res.send({"code":"ok"});
        }
    })
})
//6、查询所有通讯录数据
app.get("/listTxl",(req,res)=>{
    
    txlsModel.find({},(err,data)=>{
        if(err){
            res.send({"code":"no","msg":"查询失败"});
        }else{
            res.send({"code":"ok","info":data});
        }
    })
})
//7、删除通讯录一条数据
app.get("/delTxl",(req,res)=>{
    var _id= req.query._id;

    txlsModel.deleteOne({"_id":_id},(err,data)=>{
        if(err){
            res.send({"code":"no","msg":"删除失败"});
        }else{
            res.send({"code":"ok"});
        }
    })
})

app.listen(3000)
```

```js
//----------前端文件js------------
//选项卡
$("#tab >li").click(function(){
    $(this).addClass("tab_active").siblings().removeClass("tab_active");

    $("#tab_box >div").eq( $(this).index() ).addClass("tab_box_active").siblings().removeClass("tab_box_active");

})
// 添加
$("#add").click(function(){
    var user= $("#user").val();
    var title= $("#title").val();
    var msg= $("#msg").val();
    var time= new Date().getTime();
if(user && title && msg){

    $("#no").hide(); 

    // 保存到 草稿箱
    $.post("/addCgx",{
        user,
        title,
        msg,
        time
    },function(res){
        // console.log(res);
        if(res.code =="ok"){
              // 保存到 通讯录
                $.post("/addTxl",{
                    user
                },function(res){
                   if(res.code =="ok"){
                    // console.log("草稿箱，通讯录，都保存成功")
                    $("#yes").show()
                   }else{
                    $("#yes").hide() 
                   }
                } )
        }

    } )

}else{
   $("#no").show(); 
}


  
})


// 点击草稿箱 渲染 

$("#cgx").click(function(){
    getCgxList();
})
function getCgxList(){
    $.get("/listCgx",function(res){
        // console.log(res);
        showCgxList(res.info);
    })
}
// 渲染草稿箱
function showCgxList(arr) {
    if(arr.length>0){
        $("#noDate").hide();
        $("#show_table").show();
        var str="";
        $.each(arr,function (i,v) {
            str+=`
            <tr>
                <td>${i+1}</td>
                <td>${v.user}</td>
                <td>${v.title}</td>
                <td>${v.msg}</td>
                <td>${toTimeString(v.time)}</td>
                <td>
                    <span onclick="del('${v._id}')">删除</span>
                </td>
            </tr>
            `
        })
        $("#show_tbody").html(str);
    

    }else{
        $("#noDate").show();
        $("#show_table").hide();
       
    }

  

}

// 删除草稿箱

function del(_id) {
    $.get("/delCgx",{_id},function (res) {
        if(res.code =="ok"){
            getCgxList(); 
        }
    })
}

// 清空
$("#clear").click(function () {
    $.get("/clearCgx",function (res) {
        if(res.code =="ok"){
            getCgxList(); 
        }
    }) 
    
})



// 点击 通讯录渲染 

$("#txl").click(function(){
    getTxlList()
})

function getTxlList(){
    $.get("/listTxl",function(res){
        // console.log(res);
        showTxlList(res.info);
    })
}
// 渲染通讯录
function showTxlList(arr) {
    var str="";
    $.each(arr,function (i,v) {
        str+=`
        <li>
            <span>${i+1}.</span>
            <p class=" ${ i%2 !=0 ? 'p_active' : ''} ">
                <span>${v.user}</span>
                <span onclick="delTxl('${v._id}')">删除</span>
            </p>
        </li>
        `
    })
    $("#show_list").html(str);
}
//删除通讯录 
function delTxl(_id) {
    var flag= confirm("确定删除吗?");
    if(flag){
        $.get("/delTxl",{_id},function(res){
            if(res.code =="ok"){
                getTxlList();
            }
        }) 
    }
}

// 转时间格式
function toTimeString(time){
    var t= new Date(time);

    var year= t.getFullYear();
    var month= (t.getMonth()+1).toString().padStart(2,'0');
    var date= t.getDate().toString().padStart(2,'0');

    var hour= t.getHours().toString().padStart(2,'0');
    var minute= t.getMinutes().toString().padStart(2,'0');
    var second= t.getSeconds().toString().padStart(2,'0');

    return `${year}-${month}-${date} ${hour}:${minute}:${second}`

}
```



##### 案例2  新闻案例   分类型

```js
//------------api,路由文件-----------
//载入express*

const express =require("express");
const app =express();
*//静态页面发布*
app.use(express.static("public"));
*//post传参*

app.use(express.json());
app.use(express.urlencoded({extended:true}));

*//载入mongoose及连接数据库*

const mongoose =require("mongoose");
   mongoose.connect("mongodb://127.0.0.1:27017/p3kao",{ useUnifiedTopology: true ,useNewUrlParser: true } )

*// 创建新闻 集合 规则*
*//【 title 新闻标题、url新闻地址 、type 新闻类别、level是否标红（布尔）、time 添加时间（number） 】*

const newsSchema = new mongoose.Schema({
  title:String,
  url:String,
  type:String,
  level:Boolean,
  time:Number//Number可写为Date.now
})
*// 创建新闻 集合 模型*

const newsModel= mongoose.model("news",newsSchema);
*//1、添加新闻接口* 

app.post("/add",(req,res)=>{
  var obj =req.body;
  newsModel.create(obj,(err,data)=>{  
      if(err){
      res.send({"code":"no"});
    }else{
      res.send({"code":"ok"}); 
    }
  })
})

*//2、获取新闻信息接口*  

app.get("/list",(req,res)=>{

  *//*
  var type = req.query.type ? req.query.type :"科技";
  newsModel.find({ "type":type },{},{limit:7,sort:{"time":-1}},function(err,data){
    if(err){
      res.send({"code":"no"});
    }else{
      res.send({"code":"ok","info":data}); 
    }
  })
})
app.listen(3000)
```

```js
//------------前端js文件
//存储筛选的信息,刷新后仍然是刷新前的页面
var type = localStorage.getItem("p3kaotype")?JSON.parse(localStorage.getItem("p3kaotype")).type :"科技"
var typeArr = ["科技", "娱乐", "财经"]

//切换:点击筛选按钮给其他去样式,点击的按钮加样式
$("#filter_btn >button").click(function () {
    $(this).addClass("active").siblings().removeClass("active");
    var index = $(this).index();
    //通过点击按钮记录下标,并标记类型
    type = typeArr[index];
    //保存
    localStorage.setItem("p3kaotype",JSON.stringify({type:type}));
    //请求相关类型的页面数据
    getList(type);

})

// $.get请求数据并展示
function getList(type) {
    $.get("/list", { "type": type }, function (res) {
        showList(res.info)
    })
    // showList()
}

// 渲染----
function showList(arr) {
    var str = "";
    $.each(arr, function (i, v) {
//--里面如果v.level有值,则给li加class 为red的类名
        str += `
            <li class="${v.level ? 'red' : ''}">
                 <span>${v.title}</span>
                 <span>${toTimeString(v.time)}</span>
             </li>
        `
    })
    $("#list").html(str);
}

// 添加

$("#add").click(function () {
    //获取输入框的值
    var title = $("#title").val();
    var url = $("#url").val();
    var type = $("#type").val();
    var level = $("#addForm :radio:checked").val();
    var time = new Date().getTime();
//$post进行请求接口,post传参
    $.post("/add", {
        title, url, type, level, time
    }, function (res) {

        type = $("#type").val(); // 类别值
         //添加什么类型的数据,给下面按钮加选中样式
        checkButton(type);
       //保存
        localStorage.setItem("p3kaotype",JSON.stringify({type:type}));
        //添加什么类型的数据,渲染展示什么类型的数据
        getList(type)

    })
})
//页面加载完毕调用
$(function () {
    checkButton(type);
    getList(type);
})
//根据需求给按钮加样式
function checkButton(type){

    var index= typeArr.findIndex(v=>v == type);
    $("#filter_btn >button").eq(index).addClass("active").siblings().removeClass("active");
    
}

```

# 重点

##### jQuery的ajax的常用配置项

```js
//简单易用的高层实现见 $.get, $.post 等
$.get("http://169.254.44.235:3000/one",function(res){console.log(res);})
    $.ajax({
      type:"GET",//请求方式
      url:"http://169.254.44.235:3000/two",// 请求地址
       headers:{},    // 设置请求头
            

      data:{a:2,b:2}, 
      success:function(res){  console.log(res);}, // 请求成功 回调函数
      dataType:"text", *// 返回值的数据格式/类型 -- 默认json ，
     
      error:function(){ console.log("错误了"); },//请求失败/错误 回调函数
      beforeSend:function(){ console.log("正在请求");// 请求前  loading 效果 、请求拦截
        *// return false; //4*
      },
    
      timeout:3000, *//请求超时时间  
       cache:true ,    //true 缓存 false 不缓存
    })

//简单用法,不用配置
 $.get("http://169.254.44.235:3000/two",{"a":1,"b":2},function(res){console.log(res) },"text");
        // $.get( 请求地址, 上传参数, 成功回调，返回值的数据类型 )
 $.post("http://169.254.44.235:3000/three",function(res){ console.log(res)})    $.post("http://169.254.44.235:3000/four",{x:2,y:4},function(res){ console.log(res)})
```

#####     2http和https的区别，常见状态码有哪些 



##### 3写出Mongodb 文档操作，增 、删 、改 、查 方法

create创建

find查找

deleteOne删除1个

deleteMany删除多个

update修改



##### 写出原生ajax的基本写法

```js
//-----AJAX的初步使用-----------
//request--在其他地方可简称为req,意思是请求;
//response-- 在其他地方可简称为res  意思是应答/响应

//创建异步请求对象
var xhr = new XMLHttpRequest();
//打开连接--xhr.open(请求方式 、请求地址、是否异步)
xhr.open("GET", "http://127.0.0.1:5500/day05/%E8%87%AA%E5%B7%B1%E7%BB%83%E4%B9%A0/11.json", true);
//发送请求
xhr.send();
//监听状态改变
xhr.onreadystatechange = function () {
//ajax 状态   4成功       http 状态 200 成功
if (xhr.readyState == 4 && xhr.status == 200) {
console.log(xhr.responseText);
//转为对象
var obj = JSON.parse(xhr.responseText);

console.log(obj);

   }
}
```

##### 同源策略是什么，jsonp解决跨域的原理

script  的src请求资源

同源就是:协议  主机  端口相同即为同源

# JS进阶13

##### 1-yarn包管理器安装

​    **npm install yarn -g安装yarn包管理器**

**yarn -v查看版本**

**yarn add 模块名   下载**

​    **yarn remove 模块名,   删除**

##### 2-移动端案例

写一套样式 ，适配不同分辨率的设备（手机、平板）

rem ： 根据 html  font size值

1rem === html - fontSize

375px设备   宽度最大：375px

html ：fontSize == 37.5px

1rem == 37.5px      

```
.box{ width :10rem }
```

500px    宽度最大：500px

html ：fontSize == 50px

1rem. ==50px

```
.box{ width :10rem }
```

750px    宽度最大：750px

 html ：fontSize == 75px

1rem. ==75px

```
.box{ width :10rem }
```

html fontSize == 设备的宽度 / 10

##### 3-食物分类案例

```js
//----------后端api.js文件 -------
const express = require("express");
const app =express();
app.use(express.static("public"));
app.use(express.json());
app.use(express.urlencoded({extended:true}));

// 连接数据库
const mongoose =require("mongoose");
      mongoose.connect("mongodb://127.0.0.1:27017/p3kao",{ useUnifiedTopology: true ,useNewUrlParser: true } )

// goods 集合 规则
/**
    name 商品名 、type 类别 （1，2，3，4），
    oldPrice 原价，nowPrice现价
    num 库存、flag （true、false）是否标红 ,time 添加时间
*/
const goodsSchema=new mongoose.Schema({
    name:String,
    type:Number,
    oldPrice:Number,
    nowPrice:Number,
    num:Number,
    flag:Boolean,
    time:Number//Number可写为Date.now
})

// goods 集合 模型
const goodsModel= mongoose.model("goods",goodsSchema);


// 添加接口
app.post("/add",(req,res)=>{
    var obj= req.body;
    goodsModel.create(obj,(err,data)=>{
        if(err){
            res.send( {"code":"no"} );
        }else{
            res.send( {"code":"ok"} );
        }
    })
})

//查询商品
app.get("/list",(req,res)=>{
    //通过url上添加参数type进行查询展示
    var type =req.query.type;
    //如果查询类型没有则去除,因为没有货物的类型为空,查询会查询不到数据
    var q;
    //下拉框中option的每个value为1,2,3,4
    if(type == "0"){
        // 查询全部
        q={};
    }else{
        //分类查询
        q={"type":type}
    }   
    goodsModel.find(q,(err,data)=>{
        if(err){
            res.send( {"code":"no"} );
        }else{
            res.send( {"code":"ok","info":data} );
        }
    })
})
//删除
app.get("/del",(req,res)=>{
    var _id =req.query._id;
    goodsModel.deleteOne( {"_id":_id} ,(err,data)=>{
        if(err){
            res.send( {"code":"no"} );
        }else{
            res.send( {"code":"ok"} );
        }
    })
})


app.listen(3000);
```

```js
//----------前端js文件--------------------- 
var type =0;//  下面数组的下标    储存时都是文字,以数字存储实现优化
var typeArr=["全部","优选水果","卤味熟食","饮料酒水","休闲零食"];
$("#add").click(function(){

    var name =$("#name").val();
    var type =$("#type").val();
    var oldPrice= $("#oldPrice").val();
    var nowPrice= $("#nowPrice").val();
    var num=$("#num").val();
    var flag = $("#flag >:radio:checked").val();
    var time = new Date().getTime();

    // console.log(name,type,oldPrice,nowPrice,num,flag);

    $.ajax({
        type:"POST",
        url:"/add",
        data:{name,type,oldPrice ,nowPrice,num,flag,time},
        dataType:"json",
        success:function(res){
            console.log(res);// 如果添加成功，调用 请求数据 商品数据方法，渲染表格

            type= $("#type").val();
            getList(type);
            checkTab(type);


        },
        error:function(){
            console.log("请求出错了");
        }

    })

})

//请求数据
function getList(type){
    $.get("/list",{"type":type},function(res){
        // console.log(res)
        showList(res.info)
    })
}

//渲染 表格

function showList(arr){
    var str="";
    $.each(arr,function(i,v){
    let {name,type,oldPrice ,nowPrice,num,flag,time} =v;
       str+=`
       <tr class="${flag ?'row_active':''}">
            <td>${name}</td>
            <td>${typeArr[type]}</td>
            <td> <span class="oldPrice">¥${oldPrice}</span> </td>
            <td>¥${nowPrice}</td>
            <td>${num}</td>
            <td>${flag}</td>
            <td>
                <span class="${flag?'':'del'}">删除</span>
            </td>
        </tr>    
       `
    })
    $("#tbody").html(str);
}


// 页面加载完成调用
$(function(){
    getList(type);
    checkTab(type);
})

$("#tab > li").click(function(){

    $(this).addClass("tab_active").siblings().removeClass("tab_active")

    var index =$(this).index();

    type =index;

    getList(type);

    
})

function checkTab(type){
    // type == 1 2 3 4
    $("#tab >li").eq(type).addClass("tab_active").siblings().removeClass("tab_active")
}
```

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/index.css">
    <script src="./js/jquery.min.js"></script>
</head>
<body>

<div class="box">

    <!-- 添加表单 -->
    <form >
        <div>
            <label for="">商品名称:</label>
            <input type="text" id="name">
        </div>
        <div>
            <label for="">商品类别:</label>
            <select name="" id="type">
                <option value="1">优选水果</option>
                <option value="2">卤味熟食</option>
                <option value="3">饮料酒水</option>
                <option value="4">休闲零食</option>
            </select>
        </div>
        <div>
            <label for="">商品原价:</label>
            <input type="text" id="oldPrice">
        </div>
        <div>
            <label for="">商品现价:</label>
            <input type="text" id="nowPrice">
        </div>
        <div>
            <label for="">库存数量:</label>
            <input type="text" id="num">
        </div>
        <div id="flag">
            <label for="">是否标红:</label>
            <input type="radio" name="flag" value="true"> <span>是</span>
            <input type="radio" name="flag" value="false"  checked> <span>否</span>
        </div>
        <div>
           <input type="button" value="提交信息" id="add">
        </div>
    </form>

    <!-- 筛选  -->
    <hr/>
        <ul class="tab" id="tab">
            <li class="tab_active">全部</li>
            <li>优选水果</li>
            <li>卤味熟食</li>
            <li>饮料酒水</li>
            <li>休闲零食</li>
        </ul>
    <hr/>

    <!-- 展示表格 -->
    <table class="table" id="table">
        <thead>
            <tr>
                <th>商品名称</th>
                <th>商品类别</th>
                <th>原价</th>
                <th>现价</th>
                <th>库存</th>
                <th>是否标红</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="tbody">
            <!-- <tr>
                <td>猪头肉</td>
                <td>卤味熟食</td>
                <td> <span class="oldPrice">¥32.00</span> </td>
                <td>¥23.00</td>
                <td>12</td>
                <td>false</td>
                <td>
                    <span class="del">删除</span>
                </td>
            </tr> -->
        </tbody>
    </table>

</div>


    <script src="./js/index.js"></script>
</body>
</html>
```



# JS进阶14

##### 1--topken

1  Token的引入:Toklen是在客户端频繁向服务器的去数据库查询用户名和密码并进行对比,判断用户名和密码正确与否,并作出相应的提示,在这样的背景下,Token便应运而生.

2、Token的定义：Token是服务端生成的一串字符串，以作客户端进行请求的一个令牌，当第一次登录后，服务器生成一个Token便将此Token返回给客户端，以后客户端只需带上这个Token前来请求数据即可，无需再次带上用户名和密码。

3、使用Token的目的：Token的目的是为了减轻服务器的压力，减少频繁的查询数据库，使服务器更加健壮。

<img src="H:/编程/思维导图学习笔记/学习笔记/1.png">

node js中使用 jsonwebtoken 模块

1、下载jsonwebtoken 模块

```
npm install jsonwebtoken -S

let jwt =require("jsonwebtoken");
```

2、生成token

```js
let content = { name: data._id }; // 要生成token的主题信息

let secretOrPrivateKey = 'gaogang_token' // 这是加密的key（密钥） 

let token = jwt.sign(要生成token的主题信息, secretOrPrivateKey, {

  expiresIn: 60*60   // 1小时

});
```

3、检测token



```js
let token = req.headers.token; // 从header中获取token
    let secretOrPrivateKey = "gaogang_token"; // 这是加密的key（密钥） 

jwt.verify(token, secretOrPrivateKey, function (err) {
  if (err) {  //  时间失效的时候/ 伪造的token          
  	res.send({ 'err_code': "no" ,msg:"token失效"});
  } else {
  	res.send({ 'err_code': "ok" ,msg:"token正确"});
  }
})
```

##### 2token案例

###### 登陆功能

一、前端分析
    页面：
        1、登陆页面 【表单- 用户名、密码、登陆按钮】
        2、主页     【欢迎。。。】
    功能：
        当 登陆成功 进入 主页
           登陆失败 跳转到 登陆页


二、实现步骤

1、项目环境搭建 【项目目录、项目依赖】
2、后端：创建服务器
3、后端：发布网站

4、前端：html + css +js 【index.html 主页，login.html 登陆页面】

5、后端：实现数据接口
    5-1、数据库需求分析
         admins 集合：文档：【user用户名、password 密码】
         需要 创建 数据库、创建集合、创建 默认 用户名 密码
         【mongodb 管理工具 】
    5-2、接口分析
        1）登陆接口
            请求地址：/login
            请求方式：POST
            上传参数：user 、password
            响应数据   {"code":"ok/no" , "token":""}
                    难点： 如何生成token （token 文件夹 --文档）

 2）验证是否登陆
        请求地址：/checkToken
        请求方式：GET
        上传参数：headers:{ token:? }
        响应数据:{"code":"ok/no" }
                难点：接受到token 后 如何验证token 是否失效。（token 文件夹 --文档）


6、前后端： 测试接口 - 联调 
        【  
        postman 测试
                请求头传参数 ，
                headers 写参数       
        】

7、前端：调用接口，实现功能
    7-1、登陆页面 
         点击 登陆按钮 获取 表单数据【用户名、密码】 --ajax 调用登陆接口
         如果 登陆成功  将 返回的 token 保存到 本地存储 -跳转到 主页
         如果 登陆失败  弹框提示 ，清空 表单 输入值
    7-2、主页
         当页面 加载完成 
         ajax -调用 验证是否登陆 接口
             【
                请求头传参数 ， 
                jquery  -- $.ajax( { headers:{}  } )
                原生：  xhr.setRequestHeader("token","...."))
             】
         如果 登陆成功 继续访问
         如果 登陆失败 跳转到登陆页面

```js
//--------api.js后台文件----------------
const express = require("express");
const app =express();
app.use(express.static("public"));
app.use(express.json());
app.use(express.urlencoded({extended:true}));

// 连接mongodb
const mongoose =require("mongoose");
      mongoose.connect("mongodb://127.0.0.1:27017/p3kao",{ useUnifiedTopology: true ,useNewUrlParser: true } )


// admins 集合 规则
const adminsSchema=new mongoose.Schema({
   user:String,
   password:String
})
// admins 集合  模型
const adminsModel= mongoose.model("admins",adminsSchema);


/*
1）登陆

    请求地址： /login
    请求方式:POST
    上传参数:  user password
    响应数据 { "code":"ok/no" , token:"" }
            如何 生成token ？

*/
const jwt = require("jsonwebtoken");

app.post("/login",(req,res)=>{
    var obj =req.body;// {"user":"aaa","password":"77"}
    adminsModel.findOne( obj ,function(err,data){
        if(data){
            //生成token 
            let content = { user: data.user }; // 要生成token的主题信息
            let secretOrPrivateKey = '123456' // 这是加密的key（密钥） 

            let token = jwt.sign(content, secretOrPrivateKey, {         
              expiresIn: 30  //失效时间
            });

            res.send({"code":"ok","info":data,"token":token});
        }else{
            res.send({"code":"no"});
        }
    })
})

/**
    2) 验证是否登陆 /token 是否过期 
    请求地址： /checkToken
    请求方式:GET
    上传参数: token =？
    响应数据 { "code":"ok/no" }
            如何验证 token ？

 */

app.get("/checkToken",(req,res)=>{
    // var token = req.query.token;

    // console.log(req.headers);

    var token =req.headers.token;
    
    let secretOrPrivateKey = '123456' // 这是加密的key（密钥）  
//jwt.verify(参数1要生成token的主题信息,参数2:秘钥,参数3:秘钥过期时间)
    jwt.verify(token, secretOrPrivateKey, function (err) {
        if (err) {  //  时间失效的时候/ 伪造的token          
            res.send({ 'code': "no" ,msg:"token失效"});
        } else {
            res.send({ 'code': "ok" ,msg:"token正确"});
        }
      })
})






app.listen(3000);
```

```html
<h1>登陆页</h1>
    <form >
        <div>
            <label for="">用户名:</label>
            <input type="text" id="user">
        </div>
        <div>
            <label for="">密&emsp;码:</label>
            <input type="text" id="password">
        </div>
        <div>
         
            <input type="button" value="登陆" id="add">
        </div>
    </form>
    <script>
//点击登录按钮加点击事件
 $("#add").click(function(){
    //获取用户名及密码
   var user= $("#user").val();
   var password= $("#password").val();
  //post请求数据(用户名及密码)
  $.post("/login",{user,password},function(res){
    console.log(res);//
    if(res.code == "ok"){
   //存储token及用户名
                    localStorage.setItem("adminToken",res.token);
                    localStorage.setItem("adminUser",res.info.user);
   //跳转到主页
     window.location.href="/index.html"
   }else{
      alert("登陆失败，用户名或密码有错");
     $("#user").val("");
    $("#password").val("");
    }
  })

 })
    </script>
```

##### 3留言板案例(自增$inc)

```js
// 后端： 服务器，接口
const express = require("express");
const app=express();
app.use(express.static("public"))

const cors= require("cors");
app.use(cors());

// 连接数据库
const mongoose =require("mongoose");
mongoose.connect("mongodb://127.0.0.1:27017/p3kao",{ useUnifiedTopology: true , useNewUrlParser: true } )

// messages 集合 规则
//标题 title 、内容msg、添加时间 time、顶起 good 、鄙视bad
const messagesSchema=new mongoose.Schema({
    title:String,
    msg:String,
    time:Number,//Number可写为Date.now
    good:Number,
    bad:Number
})
// messages 集合 模型
const messagesModel= mongoose.model("messages",messagesSchema);
//接口-----
// post 
app.use(express.json());
app.use(express.urlencoded({extended:true}));
//  1）添加接口 
app.post("/add",(req,res)=>{
    var obj= req.body; // 接受参数- 对象
    //保存到数据库
    messagesModel.create(obj,(err,data)=>{
        if(err){
            res.send( {"code":"no"} );
        }else{
            res.send( {"code":"ok"} );
        }
    })
})
// 2）查询所有 
app.get("/list",(req,res)=>{

    messagesModel.find({},{},{sort:{_id:-1}},(err,data)=>{
        if(err){
            res.send( {"code":"no"} ); 
        }else{
            res.send( {"code":"ok","info":data} );
        }
    })
})
//  3）删除

app.get("/del",(req,res)=>{
    var _id = req.query._id

    messagesModel.deleteOne({"_id":_id},(err,data)=>{
        if(err){
            res.send( {"code":"no"} ); 
        }else{
            res.send( {"code":"ok"} );
        }
    })
})
// 4）鄙视 
app.get("/bad",(req,res)=>{
    var _id = req.query._id;
    messagesModel.updateOne( {"_id":_id}, { $inc:{"bad":1} }, (err,data)=>{
        if(err){
            res.send( {"code":"no"} ); 
        }else{
            res.send( {"code":"ok"} );
        }
    })
})

// 5 )顶起 
app.get("/good",(req,res)=>{
    var _id = req.query._id;
    messagesModel.updateOne( {"_id":_id}, { $inc:{"good":1} }, (err,data)=>{
        if(err){
            res.send( {"code":"no"} ); 
        }else{
            res.send( {"code":"ok"} );
        }
    })
})



app.listen(3000);
```

```js
var base ="http://169.254.44.235:3000";
// var base=""
//添加
$("#add").click(function(){
    var title =$("#title").val();
    var msg =$("#msg").val();
    var time= new Date().getTime();
    var good=0;
    var bad=0;
    //上传参数： title 、msg、time、good=0、bad=0

    $.post(`/add`, {title,msg,time,good,bad} ,function(res){
        // console.log(res)
        //--------------------
        if(res.code =="ok"){
            getList();
        }
    })

})


function getList(){
    $.get(`${base}/list`,function(res){
        // console.log(res)
        showList(res.info)
    })
}

function showList(arr){
    var str="";
    arr.forEach(function(v,i){
        str+=`

        <div class="item">
      
            <div class="title">
                <h1>${v.title}</h1>
                <p>${v.time}</p>
            </div>

        
            <div class="msg">
                <p>${v.msg}</p>                 
            </div>

        
            <ul class="sets">
                <li onclick="badFn('${v._id}')"> 鄙视 (<span>${v.bad}</span>) </li>
                <li onclick="goodFn('${v._id}')"> 顶起 (<span>${v.good}</span>) </li>
                <li onclick="del('${v._id}')"> 删除 </li>
            </ul>
        </div>
        `
    })
    $("#content").html(str);
    
}

$(function(){
    getList();
})
//删除
function del(_id){
    $.get(`${base}/del`,{"_id":_id},function(res){
        if(res.code =="ok"){
            getList();
        }
    })
}
// 鄙视
function badFn(_id){
    $.get(`${base}/bad`,{"_id":_id},function(res){
        if(res.code =="ok"){
            getList();
        }
    })
}
// 顶起
function goodFn(_id){
    $.get(`${base}/good`,{"_id":_id},function(res){
        if(res.code =="ok"){
            getList();
        }
    })
}
```



# JS进阶15

##### 小综合案例  (简单表单    增--删--改--查--搜索--分页)

```js
//-------------api  后端js接口-------------
const express = require("express");
const app=express();
app.use(express.static("public"))

const mongoose =require("mongoose");
mongoose.connect("mongodb://127.0.0.1:27017/p3kao",{ useUnifiedTopology: true ,useNewUrlParser: true } )
//p32103 集合 规则
// 姓名user、年龄age（Number）、性别sex、添加时间time
const p32103Schema=new mongoose.Schema({
    user:String,
    age:Number,
    sex:String,
    time:Number//Number可写为Date.now
})
//p32103 集合 模型
const p32103Model= mongoose.model("p32103",p32103Schema);
//post传参
app.use(express.json());
app.use(express.urlencoded({extended:true}))

// 1）添加用户接口 
app.post("/add",(req,res)=>{
    let obj= req.body;
    p32103Model.create(obj,(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })

})
// 2）查询用户数据
app.get("/list",(req,res)=>{
    //如果 name =""  查询所有 ，其他的给默认值 sort =-1、limit=3、page=1
    //排序
    let sort= req.query.sort ? Number(req.query.sort):1;
    //分页
    let limit= req.query.limit?Number(req.query.limit):3;
    let page= req.query.page?Number(req.query.page):1;
    //搜索
    let name= req.query.name;
    //有搜索条件则添加,没有则去除
    let q; //搜索条件
    if(name){
        q={"user":name}
    }else{
        q={};
    }
    //find({搜索条件},{},{限制条件},function(){})--skip-跳过  sort-排序
    p32103Model.find( q,{},{limit:limit,skip:(page-1)*limit,sort:{"age":sort} },(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok","info":data});
        }
    } )

})

// 3) 删除
app.get("/del",(req,res)=>{
    let _id=req.query._id;
    p32103Model.deleteOne({"_id":_id},(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})
//4）查询单个用户数据(修改)

app.get("/edit",(req,res)=>{
    let _id =req.query._id;
    p32103Model.findOne( {_id}, (err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok","info":data});
        }
    })
})

// 5）修改接口
app.post("/editOk",(req,res)=>{
    let obj= req.body;
    p32103Model.updateOne({"_id":obj._id},{$set:obj},(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})
//6）查询总条数
app.get("/count",(req,res)=>{
   
    let name= req.query.name;
    //有搜索条件则添加,没有则去除
    let q; //搜索条件
    if(name){
        q={"user":name}
    }else{
        q={};
    }
//countDocuments计算总的数据条数
    p32103Model.countDocuments(q,(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok","count":data});//!!!!count
        }
    })

})
app.listen(3000)

```

```js
//-------------前端页面js------------- 
var sort=1;  //排序默认升序
 var name="";  //搜索默认为空
 var limit=3;   //分页每页显示3条
 var page =1;  //当前页默认为1
 var sumPage=0; //总页数默认为0
 //添加
 $("#add").click(function(){
     var user=$("#user").val();
     var age=$("#age").val();
     var sex =$("#sex >:radio:checked").val();
     var time=new Date().getTime();
//通过user,age,sex,time请求接口
     $.post("/add",{user,age,sex,time},function(res){
        // console.log(res)
        getList(sort,name,limit,page);
     })
 })

//获取数据
 function getList(sort,name,limit,page){
    // 排序sort =[1/-1默认] 、name=？搜索、limit=？每页显示条数、page=？当前页书
    $.get("/list",{sort,name,limit,page},function(res){
        showList(res.info)
    })
}
// 渲染页面
 function showList(arr){
    str="";
    arr.forEach(function(v,i){
        str+=`
        <tr>
            <td>${v.user}</td>
            <td>${v.age}</td>
            <td>${v.sex}</td>
            <td>
                <button onclick="del('${v._id}')">删除</button>
                <button onclick="edit('${v._id}')">修改</button>
            </td>
        </tr>
        `
    })
    $("#tbody").html(str)
    getCount(name);

 }
//页面加载调用
 $(function(){
    getList(sort,name,limit,page);

 })

//按年龄升序
 $("#esc").click(function(){
     sort =1;
     getList(sort,name,limit,page)
 })
//按年龄降序
 $("#desc").click(function(){
    sort =-1;
    getList(sort,name,limit,page)
})
// 搜索

$("#search").click(function(){
     name = $("#name").val();
     page=1; // 让页数 =1
     getList(sort,name,limit,page)

})

// 获取 总条数 -- --总页数
function getCount(name){
    $.get("/count",{name},function(res){
        // console.log(res)

        //分页原理:总页数=上取整(总的数据条数/每页条数)
        sumPage= Math.ceil(res.count / limit);
        var str=""
        for(var i =1;i<= sumPage;i++ ){

            str+=`
                <button onclick="pageFn(${i})"  class="${page == i ?'y':''}">第${i}页</button>
            `
        }
    $("#page").html(str);
   //注意
    $("#nowPage").text(page);
    $("#sumPage").text(sumPage);

    })
}
// 分页
function pageFn(p){
    page = p;
    getList(sort,name,limit,page);
}

//上一页
$("#prev").click(function(){
    if(page >1){
        page -=1
        getList(sort,name,limit,page);
    }

})
//下一页 
$("#next").click(function(){
    if(page <sumPage){
        page +=1
        getList(sort,name,limit,page);
    }

})

//删除

function del(_id){
    console.log(_id)
    $.get("/del",{"_id":_id},function(res){
        console.log(res)
        getList(sort,name,limit,page);
    })
}

//修改

var editId;
function edit(_id){
    $.get("/edit",{"_id":_id},function(res){
        // console.log(res)
        $("#user").val(res.info.user);
         $("#age").val(res.info.age);
        var sexDom =$("#sex >:radio");
        sexDom.each(function(i,v){
            if( $(v).val() == res.info.sex ){
                $(v).prop("checked",true)
            }
        })
        editId = res.info._id;
    })
}
//确认修改
$("#editOk").click(function(){
    var user=$("#user").val();
    var age=$("#age").val();
    var sex =$("#sex >:radio:checked").val();
    var time=new Date().getTime();
    var _id =editId;
//需要加_id
    $.post("/editOk",{user,age,sex,time,_id},function(res){
        getList(sort,name,limit,page);
    })
})

```

```html
//---------------前端html--------------------------------
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        *{
    margin: 0;
    padding: 0;
    list-style: none;
}

.box{
    width: 50vw;
    margin: 0 auto;
    /* border: 1px solid red; */
}

.add_form [type=text]{
    width: 30vw;
    height: 30px;
    margin: 5px 0;
}
.table{
    width: 100%;
    border-collapse: collapse;
}

.table th ,.table td{
    border: 1px solid black;
    text-align: center;
}
.search{
    margin: 10px 0;
}
.y{
    color: red;
}
    </style>
    <script src="./jquery.min.js"></script>
    <!-- <link rel="stylesheet" href="./index.css"> -->
</head>
<body>
    <!-- <h1>哈哈哈哈哈</h1> -->
<div class="box">
    <!-- 添加表单 -->
    <form class="add_form">
        <div>
            <label for="">姓名:</label>
            <input type="text" id="user">
        </div>
        <div>
            <label for="" >年龄:</label>
            <input type="text" id="age">
        </div>
        <div id="sex">
            <label for="">性别:</label>
            <span>男</span><input type="radio" name="sex" value="男" checked> 
            <span>女</span><input type="radio" name="sex" value="女"> 
        </div>
        <div> 
            <input type="button" value="添加" id="add">
            <input type="button" value="确认修改" id="editOk">
            <input type="button" value="按年龄升序" id="esc">
            <input type="button" value="按年龄降序" id="desc">
        </div>
    </form>

    <!-- 搜索 -->
    <div class="search">
        <input type="text" placeholder="输入姓名搜索" id="name">
        <input type="button" value="搜索" id="search"> 
    </div>
    <!-- 展示表格 -->
    <table class="table">
        <thead>
            <tr>
                <th>姓名</th>
                <th>年龄</th>
                <th>性别</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="tbody">
            <!-- <tr>
                <td>1</td>
                <td>1</td>
                <td>1</td>
                <td>
                    <button>删除</button>
                    <button>修改</button>
                </td>
            </tr> -->
        </tbody>
    </table>

    <div id="page">
        <!-- <button>第1页</button> -->
    </div>
    <div id="page2" style="display: flex;">
        <button id="prev">上一页</button>
        <p> <span id="nowPage">1</span> / <span id="sumPage">5</span> </p>
        <button id="next">下一页</button>
    </div>
</div>
    
    <script src="./index.js"></script>
</body>
</html>
```

# JS进阶16

##### 综合案例  集所有表单类型(增-删,分页-搜索-修改-排序)

个人难点:

多选框的值获取:思路先获取到选中的复选框,循环获取val即得到复选框的值;

单选的值返到录入框:循环单选框,判断如果

```js
const express =require("express");
const app=express();
app.use(express.static("public"));

app.use(express.json());
app.use(express.urlencoded({extended:true}));


const mongoose= require("mongoose");
mongoose.connect("mongodb://127.0.0.1:27017/p3kao",{ useUnifiedTopology: true ,useNewUrlParser: true})

// dgrs 集合 规则
const dgrsSchema=new mongoose.Schema({
    user:String,
    sex:String,
    address:String,
    msg:String,
    age:Number,
    time:Number,//Number可写为Date.now
    skill:Array
})

// dgrs 集合  模型
const dgrsModel=mongoose.model("dgrs",dgrsSchema);

// 1）添加
app.post("/add",(req,res)=>{
    var obj = req.body;
    dgrsModel.create(obj,(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})
//2）查询 (多条件、排序、分页)
app.post("/list",(req,res)=>{
    //搜索内容如果有则进行搜索,没有则搜索全部,相当于设置默认值
    var search= req.body.search ? req.body.search  :{};
    var sortVal= req.body.sortVal? Number(req.body.sortVal):1;
    var sortType= req.body.sortType ? req.body.sortType :"time";


    var limit= req.body.limit;
    var page= req.body.page?Number(req.body.page):1;

    for(var key in search){
        if(!search[key]){
            delete search[key]
        }
    }
//当limit=all,skip计算时会出现NAN,所以在此做判断
    var sls;
    if(limit == "all"){
        sls={sort:{[sortType]:sortVal}}
    }else{
        limit = limit?Number(limit):3;
        sls={ limit:limit,skip:(page-1)*limit ,sort:{[sortType]:sortVal}  }
    }

    // console.log(sls)

    dgrsModel.find( search,{},sls,(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok","info":data});
        }
    } )
})

//3）总共多少条数据

app.post("/count",(req,res)=>{
    var search= req.body.search ? req.body.search  :{};
    for(var key in search){
        if(!search[key]){
            delete search[key]
        }
    }

    dgrsModel.countDocuments(search,(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok","info":data});
        }
    })
})
// 6）删除单条
app.get("/delOne",(req,res)=>{
    var _id =req.query._id;
    dgrsModel.deleteOne({_id},(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})
// 5）删除选中多条

app.get("/delMany",(req,res)=>{
    var ids=req.query.ids ;
    // console.log(ids.split(","));
    if( typeof ids == 'string' ){
        ids=ids.split(",")
    };

    dgrsModel.deleteMany({ _id:{$in:ids} },(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })

})
// 4）删除全部
app.get("/delAll",(req,res)=>{
    dgrsModel.deleteMany({},(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})

// 7）_id 查询用户信息（点击修改）

app.get("/edit",(req,res)=>{
    var _id =req.query._id;
    dgrsModel.findOne({_id},(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok","info":data});
        }
    })
})

// 8）确认修改

app.post("/editOk",(req,res)=>{
    var obj = req.body;
    dgrsModel.updateOne({"_id":obj._id},{$set:obj},(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})





app.listen(3000)

```

```js
var search={ "user":"","age":"","address":"" },
sortType="time",
sortVal=-1,
limit=3,
page=1,
sumPage=0;

//添加
$("#add").click(function(){
    var user=$("#user").val();
    var sex= $("#sex>:radio:checked").val();
    var address=$("#address").val();
    var age=$("#age").val();
//复选框选中的框进行循环,分别把选中的值加到空数组
    var skill=[];
    $("#skill >:checkbox:checked").each(function(i,v){
        skill.push($(v).val())
    })
    var msg =$("#msg").val()
    var time =new Date().getTime();
    // console.log(user,sex,address,age,skill,msg);

    if(user && sex && address && age && skill.length>0 && msg){
        
        $.post("/add",{user,sex,address,age,skill,msg,time},function(res){
            if(res.code == "ok"){
                console.log("调用 请求数据接口，渲染表格");
                getList(search,sortType,sortVal,limit,page);
            }else{
                console.log("添加出错");
            }
        })

    }else{
        alert("不能为空")
    }

})

/*
search：{ "user":"","age":"","address":"" }
sortVal: 1/-1
sortType: age / time
limit :每页显示条数  ？all  查询所有
page ：当前第几页 
*/

//请求数据
function getList(search,sortType,sortVal,limit,page){
    $.post("/list",{
        search,sortType,sortVal,limit,page     
    },function(res){
        // console.log(res);
        showList(res.info)
    })
}
//渲染
function showList(arr){
  if(arr.length>0){
     $("#table").show();
     $("#noData").hide();
     $("#pageList").show();
     $("#pageFn").show()
     var str="";
     arr.forEach(function(v,i){
         str+=`
             <tr>
                 <td>
                     <input type="checkbox" value="${v._id}"> 
                 </td>
                 <td>${v.time}</td>
                 <td>${v.user}</td>
                 <td>${v.age}</td>
                 <td>${v.sex}</td>
                 <td>${v.address}</td>
                 <td>${v.skill.join("-")}</td>
                 <td>${v.msg}</td>
                 <td>
                     <button onclick="delOne('${v._id}')">删除</button>
                     <button onclick="edit('${v._id}')">修改</button>
                 </td>
             </tr>
         `
     })
     $("#tbody").html(str);
     getCount(search);
     $("#checkAll").prop("checked",false)
  }else{
    $("#table").hide();
    $("#noData").show();
    $("#pageList").hide();
    $("#pageFn").hide();
  }
   
}
//页面加载完调用
$(function(){
    getList(search,sortType,sortVal,limit,page)
})
//排序
function sortFn(a,b){
    console.log(a,b)
    sortType =a;
    sortVal =b;
    getList(search,sortType,sortVal,limit,page);
}

// 搜索
$("#searchBtn").click(function(){
    //search赋值
    search.user =$("#suser").val();
    search.address=$("#saddress").val();
    search.age=$("#sage").val();

    getList(search,sortType,sortVal,limit,page);
})

//获取总条数 -计算 总页数
function getCount(search){
    $.post("/count",{"search":search},function(res){
        // console.log(res)
        if(limit == "all"){
            sumPage =1;
            page =1;
        }else{
            sumPage=Math.ceil( res.info/limit );
        }
        
        var str=""
        for(var i=1;i<=sumPage;i++){
            str+=`
            <button onclick="pageFn(${i})" class="${page == i ? 'y' :''}">第${i}页</button>
            `
        }
       
        $("#pageList").html(str);

        $("#nowPage").text(page);
        $("#sumPages").text(sumPage);


    })
}
//分页
function pageFn(i){
    page= i;
    getList(search,sortType,sortVal,limit,page)

}
//改变每页条数limit
$("#limitSel").change(function(){
    // console.log( $(this).val() );
    limit = $(this).val();

    
    getList(search,sortType,sortVal,limit,page)

})
//上一页
$("#prev").click(function(){
    if(page >1){
        page-=1;
        getList(search,sortType,sortVal,limit,page)
    }
})
//下一页
$("#next").click(function(){
    if(page <sumPage){
        page+=1;
        getList(search,sortType,sortVal,limit,page)
    }
})
//跳转到x页
$("#pageNum").keydown(function(event){
    // console.log("sss")
    if(event.keyCode == 13){
        var p= $(this).val();
        // console.log(p)
        if( p >0 && p<=sumPage){
            page =p;
            getList(search,sortType,sortVal,limit,page)
        }else{
            $(this).val("")
        }
    }
})


// 删除一条
function delOne(_id){
    $("#m_box").show();

    $("#ok").click(function(){
        $.get("/delOne",{_id},function(){
            getList(search,sortType,sortVal,limit,page);
            $("#m_box").hide();
        })
    })

    $("#no").click(function(){
        $("#m_box").hide();
    })
   
}
//删除全部
$("#delAll").click(function(){
    $.get("/delAll",function(){
        getList(search,sortType,sortVal,limit,page);
    })
})
//删除选中
$("#delMany").click(function(){
    var ids=[];
    $("#tbody :checkbox:checked").each(function(i,v){
        // console.log($(v).val() )
        ids.push( $(v).val() )
    })
  
    $.get("/delMany",{ids},function(){
        getList(search,sortType,sortVal,limit,page);
    })
})

//全选
$("#checkAll").change(function(){
    var all= $(this).prop("checked");
    // console.log(all);

    $("#tbody :checkbox").prop("checked",all)

})
//修改
var editId;
function edit(_id){
    $("#add").hide();
    $("#editOk").show();

    $.get("/edit",{_id},function(res){
        // console.log(res)
        let {user,sex,address,age,skill,msg,time,_id} = res.info

        $("#user").val(user);
        $("#address").val(address);
        $("#age").val(age);
        $("#msg").val(msg)
        time =new Date().getTime();

        $("#sex>:radio").each(function(i,v){
            if( $(v).val() == sex){
                $(v).prop("checked",true)
            }
        })

        $("#skill >:checkbox").prop("checked",false);
        $("#skill >:checkbox").each(function(i,v){

            if( skill.includes( $(v).val() ) ){
                $(v).prop("checked",true)
            }
        })

        editId= _id;

    })
}
//修改确认
$("#editOk").click(function(){
    $("#add").show();
    $("#editOk").hide();

    var user=$("#user").val();
    var sex= $("#sex>:radio:checked").val();
    var address=$("#address").val();
    var age=$("#age").val();
     //复选框赋值
    var skill=[];
    $("#skill >:checkbox:checked").each(function(i,v){
        skill.push($(v).val())
    })
    var msg =$("#msg").val()
    var time =new Date().getTime();

    var _id = editId
    // console.log(user,sex,address,age,skill,msg);
    //非空验证
    if(user && sex && address && age && skill.length>0 && msg){
        
        $.post("/editOk",{user,sex,address,age,skill,msg,time,_id},function(res){
            if(res.code == "ok"){
                console.log("调用 请求数据接口，渲染表格");
                getList(search,sortType,sortVal,limit,page);
            }else{
                console.log("添加出错");
            }
        })

    }else{
        alert("不能为空")
    }
 
})



```

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #noData{
    display: none;
}
#table {
    margin: 10px 0;
    width: 80vw;
    border-collapse: collapse;
}
#table th ,#table td{
    border: 1px solid red;
    text-align: center;
}

.y{
    color: red;
}

#editOk{
    display: none;
}

.m_box{
    position: absolute;
    top: 0;
    left: 0;
    width: 100vw;
    min-height: 100vh;
    background: rgba(0,0,0,.4);
    display: none;
}
.m_item{
    background: white;
    width: 30vw;
    text-align: center;
    position: absolute;
    top:50%;
    left:50%;
    transform: translate(-50%,-50%);

}
    </style>
    <script src="./jquery.min.js"></script>
    <!-- <link rel="stylesheet" href="./index.css"> -->
</head>
<body>
    <div id="app" class="app">
        <!-- 添加表单 -->
        <form>
 
            <div>
                <label for="">姓名：</label>
                <input type="text" id="user">
            </div>

            <div id="sex">
                <label for="">性别：</label>
               <span>男</span> <input type="radio" name="sex" value="男" checked> 
               <span>女</span> <input type="radio" name="sex" value="女"> 

            </div>

            <div>
                <label for="">籍贯：</label>
                <select name="" id="address">
                    <option value="陕西">陕西</option>
                    <option value="河南">河南</option>
                    <option value="河北">河北</option>
                </select>
            </div>

            <div>
                <label for="">年龄：</label>
                <input type="text" id="age">
            </div>

            <div id="skill">
                <label for="">技能：</label>
                <span>html</span> <input type="checkbox" value="html">
                <span>css</span> <input type="checkbox" value="css">
                <span>javascript</span> <input type="checkbox" value="javascript">
                <span>vue</span> <input type="checkbox" value="vue">
                <span>react</span> <input type="checkbox" value="react">
                <span>angular</span> <input type="checkbox" value="angular">
                <span>uni-app</span> <input type="checkbox" value="uni-app">

            </div>

            <div>
                <label for="">备注：</label>
                <textarea  id="msg" cols="30" rows="5"></textarea>
            </div>

            <div>
               
                <input type="button" value="添加" id="add"> 
                <input type="button" value="确认修改" id="editOk"> 

            </div>
        </form>

        <!-- 搜索 -->

        <div>
            <input type="text" placeholder="姓名" id="suser">
            <input type="text" placeholder="年龄" id="sage">

            <select name="" id="saddress">
                <option value="">全部</option>
                <option value="陕西">陕西</option>
                <option value="河南">河南</option>
                <option value="河北">河北</option>
            </select>
            <input type="button" value="搜索" id="searchBtn">

        </div>
        <!-- 排序 -->
        <div>
            <button onclick="sortFn('age',1)">年龄升序</button>
            <button onclick="sortFn('age',-1)">年龄降序</button>
            <button onclick="sortFn('time',1)">入职时间-升序</button>
            <button onclick="sortFn('time',-1)">入职时间-降序</button>
        </div>

        <!-- 展示 -->
        <table id="table"> 
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="checkAll">
                    </th>
                    <th>入职时间</th>
                    <th>姓名</th>
                    <th>年龄</th>
                    <th>性别</th>
                    <th>籍贯</th>
                    <th>技能</th>
                    <th>备注</th>    
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="tbody">
                <!-- <tr>
                    <td>
                        <input type="checkbox"> 
                    </td>
                    <td>2016-10-08</td>
                    <td>gao</td>
                    <td>19</td>
                    <td>男</td>
                    <td>陕西</td>
                    <td>html-css-js-vue</td>
                    <td>讲师</td>
                    <td>
                        <button>删除</button>
                        <button>修改</button>
                    </td>
                </tr> -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="5" id="delMany">选中删除</td>
                    <td colspan="4" id="delAll">全部删除</td>
                </tr>
            </tfoot>
        </table>
        
        <h1 id="noData">暂无数据 请添加</h1>

    <!-- 分页 -->

        <div id="pageList">
            <!-- <button>第1页</button> -->
       
        </div>

        <div id="pageFn">
            <select name="" id="limitSel" >
                <option value="3">3</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="all">all</option>
            </select>

             <span id="prev"> &lt; </span>
             <span id="nowPage">1</span>/<span id="sumPages">5</span>
             <span id="next"> &gt; </span>
           <span>跳转到</span> <input type="text" id="pageNum">  <span>页</span>
        </div>



        <div class="m_box" id="m_box">
            <div class="m_item">
                <h1>确认删除吗</h1>
                <button id="ok">确认</button>
                <button id="no">取消</button>
            </div>
        </div>

    </div>

    <script src="./index.js"></script>
</body>
</html>
```

# JS进阶17

##### 1  利用对象的  属性不能重复,来实现数组去重

```js
 //新建一个数组       
var arr=[1,2,3,4,3,2,1];
//把数组变成下面的形式
 //1:1,2:2,3:3,4:4,3:3,2:2,1:1
var obj={},arr2=[];
//遍历对象
for(var i=0;i<arr.length;i++){
     obj[arr[i]]=arr[i];//把数组的第i个值
}
        console.log(obj);

for(var key in obj){
      arr2.push( obj[key] )
}
        console.log(arr2);
```

##### 2 箭头函数

```js
//箭头函数
var c=(x,y)=>{
colsole.log(x,y)
}
//普通函数
var c=function(x,y){
    console.log(x,y)
}
//调用传参
c(2,3)
//箭头函数与普通函数的区别:不能改变this的指向,this指向声明或创建时的对象.

```

##### 3 new干了什么

```
1创建对象,

2改变了构造函数的指向,指向新创建的对象

3.给新对象赋值

4返回新对象
```

##### **4  注册表单自动验证ajax**



```js
//--------后端api.js-------------
const express =require("express");
const app=express();
app.use(express.static("public"));

app.use(express.json());
app.use(express.urlencoded({extended:true}));

const mongoose= require("mongoose");
mongoose.connect("mongodb://127.0.0.1:27017/p3kao",{ useUnifiedTopology: true ,useNewUrlParser: true})

// goods 集合 规则
const testSchema=new mongoose.Schema({
    username:String,
    password:Number,
   
})

// goods 集合  模型
const testModel=mongoose.model("test",testSchema);

//查询用户名是否存在
app.get("/checkUser",(req,res)=>{
    var username =req.query.username;
    testModel.findOne({"username":username},(err,data)=>{
        if(data){
            res.send({"code":"no","msg":"用户名已经注册"});
        }else{
            res.send({"code":"ok"});
        }
    })
})
//注册
app.post("/add",(req,res)=>{
    var obj =req.body;
    testModel.create(obj,(err,data)=>{
        if(err){
            res.send({"code":"no"});
        }else{
            res.send({"code":"ok"});
        }
    })
})

app.listen(3000);
```

前端html文件  index.html

```html
    <form>
        <div>
            <label for=""></label>
            <input type="text" id="username">
            <span id="cusername"></span>
        </div>
        <div>
            <label for=""></label>
            <input type="text" id="password">
        </div>
        <div>
            <label for=""></label>
            <input type="button" value="注册" id="reguserBtn">
        </div>
    </form>
```

前端  js文件

```js
      var usernameDom = document.getElementById("username");
      usernameDom.onblur = function () {
      //console.log(this.value);
            // console.log(1132);
      var xhr = new XMLHttpRequest();
      xhr.open("GET", `./checkUser?Username=${this.value}`, true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send()
      xhr.onreadystatechange = function () {
          if (xhr.readyState == 4 && xhr.status == 200) {
              var obj = JSON.parse(xhr.responseText);
              console.log(obj);
              if (obj.code == "no") {
                  document.getElementById("cusername").innerText = obj.msg;
                  document.getElementById("reguserBtn").disabled = true;//如果用户名已占用,注册按钮禁用
              } else {
                  document.getElementById("cusername").innerText = "ok"
              }
          }
      }
  }
  var reguserBtn = document.getElementById("reguserBtn");
  reguserBtn.onclick = function () {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", `./checkUser?Username=${this.value}`, true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send()
      xhr.onreadystatechange = function () {
          if (xhr.readyState == 4 && xhr.status == 200) {
              var obj = JSON.parse(xhr.responseText);
              if (obj.code == "ok") {
                  alert("注册成功")
              }
          }
      }
  }
```

##### 5   fetch请求

新版浏览器EDGE支持,ie都不支持 (  除了ajax请求之外 的方法),下面为 MDN 网址

https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch

```js
  //fetch默认为get请求,
  fetch("/list")
      .then(res => res.json()) //确定返回值的数据类型格式.json为json格式,还可以为text格式,xml格式
      /* .then(function(res){
          return res.json()
      }) */
      .then(res => {
          console.log(res);
      })

  //---fetch也可以为post请求---
  fetch("/list", {
          method: "POST",
          body: JSON.stringify({
              user: "gao",
              "age": 89
          }),
          
          //body: 'username=1111&password=2212',
          headers: new Headers({
              'Content-Type': 'application/json'
          })
      })
      .then(res => res.json()) //确定返回值的数据类型格式.json为json格式,还可以为text格式,xml格式
      /* .then(function(res){
          return res.json()
      }) */
      .then(res => {
          console.log(res);
      })
```





ajax调试看network

********登录成功之后,返回token,测试其他接口时,token在postman测试接口工具Authorization里测试,type选Bearer,粘贴Brear后面的内容********

node.js是js的运行环境,单线程,事件驱动,安装,--下载--node环境是基础环境

jsp     php

##### 4  文件上传

参考网址：https://blog.csdn.net/yun_hou/article/details/96869219

1、接口：(需要下载  multer  模块)

```js
// 载入  multer 
let multer = require("multer");
let storage = multer.diskStorage({
    // 文件存储路径
    destination: function (req, file, cb) {
        cb(null, "./public/img")
    },
    //文件名
    filename: function (req, file, cb) {
        cb(null, file.originalname)
    }
})

let up = multer({ storage: storage });

app.post("/fileup", up.single("picture"), (req, res) => {
   
	if (req.file) {
		console.log('/img/' + req.file.originalname) // 文件名
		console.log(req.body.name, req.body.age) // 
		res.send({ "error_code": 200, "msg": "ok" })
	} else {
		res.send({ "error_code": 400, "msg": "no" })
	}
  
})
```

2、前端 from 表单上传图片

```html
	<form action="/fileup" method="post" enctype="multipart/form-data">
		<input type="file" name="picture" />
		<input type="submit" value="提交" />
	</form>
```



3、前端ajax 

```html
<div>
       <input type="file" id="singleFile">
        <input type="button" value="上传" id="up">
  </div>
```



```js
//载入jquery
$("#up").click(function () {
		var fileList = $('#singleFile')[0].files;
	
		var formData = new FormData();
		//此处文件名必须为 picture ，因为后台设置接口为此文件名up.single("picture")
		formData.append('picture', fileList[0]);

		$.ajax({
			url: '/fileup',
			type: 'post',
			processData: false,//不会序列化 data,
			contentType: false,//使用multer配合ajax时无需配置multipart/form-data，multer将自动配置，手动配置将报错，boundary not found
			data: formData,
			success: function (data) {
				console.log(data)

			}
		})
	})

```

测试postmanhttps://www.cnblogs.com/liuzhi20101016/p/11445153.html

ApiPost下载地址：https://www.apipost.cn/

思考?如果多个数据表如何?



# mongoose 查询

## 

### 查询方法

mongoose查询使用的最基础的方法就是find、findOne和findById等方法，find查询所有满足条件的值并且返回一个数组，findOne和findById取满足条件的某一个值,返回的是一个object。

```
Model.find(conditions, [fields], [options], [callback])
```

**注：conditions 查询条件、fields 想要返回的字段、options 操作、callback 回调函数**

栗子： 查询用户表下面名字为张三的从第二条开始的后两条文档且只需按时姓名、性别、居住地址、创建时间信息并按创建时间倒叙显示

```js
//对象写法
userModel.find({'name':'张三'},{'name':1,'sex':1,'region':1,'createBy':1,'_id':0},{ limit:2, skip:1, sort:'-createBy.createTime'})

//链式写法
userModel.find({'name':'张三'},{'name':1,'sex':1,'region':1,'createBy':1,'_id':0}).skip(7).limit(2).sort({'createBy.createTime' : -1})

```

### 常见的查询条件

mongoose查询条件其实就是在find或findOne方法的基础上添加mongodb条件操作符

常见的mongodb条件操作符有很多,如下:

```
    $or　　　　或关系

　　$nor　　　 或关系取反

　　$gt　　　　大于

　　$gte　　　 大于等于

　　$lt　　　　 小于

　　$lte　　　  小于等于

　　$ne            不等于

　　$in             在多个值范围内

　　$nin           不在多个值范围内

　　$all            匹配数组中多个值

　　$regex　　正则，用于模糊查询

　　$size　　　匹配数组大小

　　$maxDistance　　范围查询，距离（基于LBS）

　　$mod　　   取模运算

　　$near　　　邻域查询，查询附近的位置（基于LBS）

　　$exists　　  字段是否存在

　　$elemMatch　　匹配内数组内的元素

　　$within　　范围查询（基于LBS）

　　$box　　　 范围查询，矩形范围（基于LBS）

　　$center       范围醒询，圆形范围（基于LBS）

　　$centerSphere　　范围查询，球形范围（基于LBS）

　　$slice　　　　查询字段集合中的元素（比如从第几个之后，第N到第M个元素）
复制代码
```

#### 字段的显示与隐藏

在 mongoose 中有两种指定方式，字符串指定和对象形式指定。

1.字符串指定时在排除的字段前加 - 号，只写字段名的是包含。

```
Model.find({},'age');
Model.find({},'-name');
复制代码
```

2.对象形式指定时，1 是包含，0 是排除。

```
Model.find({}, { age: 1 });
Model.find({}, { name: 0 });

```

#### 分页查询

1. sort：按照排序规则根据所给的字段进行排序，值可以是 asc, desc, ascending, descending, 1, 和 -1。
2. limit：指定返回结果的最大数量。
3. skip：指定要跳过的文档数量
4. lean：返回普通的 js 对象，而不是 Mongoose Documents。建议不需要 mongoose 特殊处理就返给前端的数据都最好使用该方法转成普通 js 对象。

```
注：sort 和 limit 同时使用时，调用的顺序并不重要，返回的数据都是先排序后限制数量。
Model.find(conditions).skip(pageTotal * pageNum).limit(pageTotal).sort({'_id':-1}).exec(cb);
复制代码
```

pageTotal为每页显示条数、pageNum为分页数量、cb为回调函数,sort({'_id':-1})为按照_id倒叙排列

#### 查询非空字段

```
Model.find(conditions:{$exists:true})
Model.find(conditions:{$ne:null})

```

#### 数组对象的查找

数据

```
{author: [{name: "dora", age: 18 },{name: "wang", age: 16 }]}

```

1.精确查询

```
Model.find({ author: { name: "dora", age: 18 } })

```

2.点语法查询

```
Model.find({ 'author.age': { $gte: 18 } })

```

3.$elemMatch 同时满足所有查询条件

```
Model.find({ "author": {$elemMatch: {name: 'dora', age:{ $lt: 18 }}})
// []

```

#### 数组的下标查询

数据

```
{ year: [ 2018, 2019 ] }
{ year: [ 2017, 2019, 2020 ] }
{ year: [ 2016, 2020 ] }

```

数组 year 的第二个值大于2019。

```
Model.find({ 'year.1': { $gt: 2019 } })
// { "_id" : ..., "year" : [ 2016, 2020 ] }

```

#### 嵌套对象字段的查找

数据

```
{
  name: { first: "dora", last: "wang" }
}

```

1.精确匹配，顺序、字段都必须一致。

```
Model.find({ name: { last: "wang", first: "dora" } })
// [] 找不到数据

```

2.使用点语法，可匹配嵌套的字段，其中字段名必须用引号引起来。

```
Model.find({ 'name.last': 'wang' })

```

#### 多表联合查询

mongoose其实没有多表联合查询的方法，不过我们可以通过多次查询来实现。 通过user的name、post的content查询post: schema.js

```js
var mongoose = require('mongoose');
var Schema   = mongoose.Schema;

var UserSchema = new Schema({
    name  : { type: String, unique: true },
    posts : [{ type: Schema.Types.ObjectId, ref: 'Post' }]
});
var User = mongoose.model('User', UserSchema);

var PostSchema = new Schema({
    poster   : { type: Schema.Types.ObjectId, ref: 'User' },
    comments : [{ type: Schema.Types.ObjectId, ref: 'Comment' }],
    title    : String,
    content  : String
});
var Post = mongoose.model('Post', PostSchema);

User.find({name: name}, function (err, users) {
    Post.find({poster: {$in: users}, content: content}, function (err, posts) {
        console.log(posts)
    })
})
```

https://www.angularjs.net.cn/   

